<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#3B82F6">
    <meta name="description" content="Ù…Ù†Ø¸Ù… Ø§Ù„Ø¯Ø±Ø§Ø³Ø© - Ù†Ø¸Ù… Ù…ÙˆØ§Ø¯Ùƒ ÙˆÙ…Ø­Ø§Ø¶Ø±Ø§ØªÙƒ Ø¨Ø³Ù‡ÙˆÙ„Ø©">
    <link rel="manifest" id="manifest-placeholder">
    <link rel="apple-touch-icon" href="https://hsynb7590-dev.github.io/Be-Regular-MNU-1/icon.png">
    <title>Ù…Ù†Ø¸Ù… Ø§Ù„Ø¯Ø±Ø§Ø³Ø©</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #E0F2FE 0%, #DDD6FE 100%); min-height: 100vh; padding: 1rem; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); padding: 2rem; margin-bottom: 1.5rem; text-align: center; }
        .header h1 { font-size: 2rem; color: #1F2937; margin-bottom: 0.5rem; }
        .header p { color: #6B7280; }
        .nav-tabs { display: flex; gap: 1rem; margin-bottom: 1.5rem; overflow-x: auto; padding: 0.5rem; }
        .nav-tab { background: white; border-radius: 0.75rem; padding: 1rem 1.5rem; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.1); white-space: nowrap; display: flex; align-items: center; gap: 0.5rem; font-weight: 600; }
        .nav-tab:hover { box-shadow: 0 8px 25px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .nav-tab.active { background: linear-gradient(135deg, #3B82F6 0%, #6366F1 100%); color: white; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
        .subjects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
        .subject-card { background: white; border-radius: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 1.5rem; border: 2px solid transparent; transition: all 0.3s; cursor: pointer; }
        .subject-card:hover { border-color: #3B82F6; box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .subject-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .subject-image { width: 64px; height: 64px; border-radius: 50%; object-fit: cover; border: 2px solid #BFDBFE; }
        .subject-info h3 { font-size: 1.125rem; color: #1F2937; margin-bottom: 0.25rem; }
        .subject-info p { font-size: 0.875rem; color: #6B7280; }
        .add-subject-btn { background: linear-gradient(135deg, #60A5FA 0%, #6366F1 100%); color: white; border: 2px dashed #93C5FD; border-radius: 1rem; padding: 3rem; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 1rem; transition: all 0.3s; min-height: 160px; }
        .add-subject-btn:hover { box-shadow: 0 8px 25px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 0.75rem; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #3B82F6 0%, #6366F1 100%); color: white; }
        .btn-primary:hover { box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
        .btn-danger { background: #EF4444; color: white; }
        .btn-danger:hover { background: #DC2626; }
        .input { width: 100%; padding: 0.75rem; border: 2px solid #D1D5DB; border-radius: 0.75rem; font-size: 1rem; transition: border-color 0.3s; }
        .input:focus { outline: none; border-color: #3B82F6; }
        .textarea { width: 100%; padding: 0.75rem; border: 2px solid #D1D5DB; border-radius: 0.75rem; font-size: 1rem; min-height: 120px; resize: vertical; font-family: inherit; }
        .textarea:focus { outline: none; border-color: #3B82F6; }
        .upload-area { border: 2px dashed #D1D5DB; border-radius: 0.75rem; padding: 2rem; text-align: center; cursor: pointer; transition: border-color 0.3s; }
        .upload-area:hover { border-color: #3B82F6; }
        .upload-preview { position: relative; display: inline-block; }
        .upload-preview img { max-width: 100%; border-radius: 0.75rem; }
        .delete-btn { background: #EF4444; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .delete-btn:hover { background: #DC2626; }
        .week-card { background: linear-gradient(135deg, #ECFDF5 0%, #DBEAFE 100%); border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem; border: 1px solid #D1FAE5; }
        .week-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .week-files { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; }
        .file-upload { border: 2px dashed #D1D5DB; border-radius: 0.5rem; padding: 0.75rem; text-align: center; cursor: pointer; }
        .file-uploaded { background: white; padding: 0.5rem; border-radius: 0.5rem; display: flex; flex-direction: column; gap: 0.25rem; align-items: center; }
        .file-name { font-size: 0.7rem; color: #059669; text-align: center; word-break: break-all; max-width: 100%; }
        .file-open-btn { background: #10B981; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.7rem; cursor: pointer; margin-top: 0.25rem; }
        .file-open-btn:hover { background: #059669; }
        .hidden { display: none !important; }
        .back-btn { color: #3B82F6; cursor: pointer; font-size: 1rem; margin-bottom: 1rem; display: inline-block; }
        .back-btn:hover { color: #2563EB; }
        .exam-schedule-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .exam-schedule-table th, .exam-schedule-table td { padding: 1rem; text-align: right; border-bottom: 1px solid #E5E7EB; }
        .exam-schedule-table th { background: linear-gradient(135deg, #3B82F6 0%, #6366F1 100%); color: white; font-weight: 600; }
        .exam-schedule-table tr:hover { background: #F3F4F6; }
        .exam-type-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 600; }
        .badge-mid { background: #FEF3C7; color: #92400E; }
        .badge-final { background: #DBEAFE; color: #1E40AF; }
        .search-input { width: 100%; padding: 1rem; border: 2px solid #D1D5DB; border-radius: 0.75rem; font-size: 1.125rem; transition: all 0.3s; margin-bottom: 1.5rem; }
        .search-input:focus { outline: none; border-color: #3B82F6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .research-card { background: linear-gradient(135deg, #F0F9FF 0%, #FEF3C7 100%); border-radius: 1rem; padding: 1.5rem; margin-bottom: 1rem; border: 2px solid #BFDBFE; }
        .research-card h3 { color: #1F2937; margin-bottom: 0.5rem; }
        .research-card p { color: #6B7280; margin-bottom: 1rem; }
        .research-links { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .research-link { background: white; color: #3B82F6; padding: 0.5rem 1rem; border-radius: 0.5rem; text-decoration: none; font-weight: 600; transition: all 0.3s; border: 2px solid #3B82F6; }
        .research-link:hover { background: #3B82F6; color: white; }
        .highlight-yellow { background-color: #FEF08A; }
        .highlight-green { background-color: #BBF7D0; }
        .highlight-blue { background-color: #BFDBFE; }
        .highlight-pink { background-color: #FBCFE8; }
        .add-exam-btn { background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.75rem; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s; }
        .add-exam-btn:hover { box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
        .schedule-btn { background: linear-gradient(135deg, #A855F7 0%, #EC4899 100%); color: white; padding: 1rem; border-radius: 0.75rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-weight: 600; transition: all 0.3s; }
        .schedule-btn:hover { box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4); }

        /* â”€â”€ BRV: Better File Viewer (4-Layer Fallback) â”€â”€ */
        .brv-modal { position: fixed; inset: 0; background: rgba(0,0,0,.95); z-index: 10000; display: flex; flex-direction: column; }
        .brv-header { background: linear-gradient(135deg,#1F2937 0%,#374151 100%); padding: 1rem; display: flex; justify-content: space-between; align-items: center; gap: .75rem; box-shadow: 0 4px 6px rgba(0,0,0,.3); flex-shrink: 0; }
        .brv-title { color: #fff; font-size: 1rem; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
        .brv-actions { display: flex; gap: .5rem; flex-shrink: 0; }
        .brv-btn { border: none; border-radius: .5rem; padding: .6rem 1rem; cursor: pointer; font-weight: 600; font-size: .875rem; transition: all .2s; }
        .brv-btn-dl { background: #10B981; color: #fff; }
        .brv-btn-dl:hover { background: #059669; }
        .brv-btn-close { background: #EF4444; color: #fff; }
        .brv-btn-close:hover { background: #DC2626; }
        .brv-content { flex: 1; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; background: #374151; padding: 1rem; }
        .brv-loading { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 300px; color: #fff; gap: 1rem; text-align: center; }
        .brv-layer-badge { font-size: .75rem; background: rgba(255,255,255,.15); padding: .25rem .75rem; border-radius: 1rem; }
        .brv-spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,.25); border-top-color: #3B82F6; border-radius: 50%; animation: brv-spin 1s linear infinite; }
        @keyframes brv-spin { to { transform: rotate(360deg); } }
        .brv-page-canvas { width: 100%; max-width: 100%; display: block; margin-bottom: 4px; background: #fff; }
        .brv-page-count { text-align: center; color: #fff; padding: .5rem; font-size: .875rem; margin-bottom: .5rem; }
        .brv-iframe { width: 100%; height: 80vh; border: none; display: block; background: #fff; }
        .brv-dl-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 300px; background: #fff; border-radius: 1rem; padding: 3rem; margin: auto; max-width: 400px; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Ù…Ù†Ø¸Ù… Ø§Ù„Ø¯Ø±Ø§Ø³Ø©</h1>
            <p>Ù†Ø¸Ù… Ù…ÙˆØ§Ø¯Ùƒ ÙˆÙ…Ø­Ø§Ø¶Ø±Ø§ØªÙƒ Ø¨Ø³Ù‡ÙˆÙ„Ø©</p>
        </div>

        <div class="nav-tabs">
            <div class="nav-tab active" id="tab-subjects">ğŸ“š Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</div>
            <div class="nav-tab" id="tab-exams">ğŸ“ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</div>
            <div class="nav-tab" id="tab-research">ğŸ” Ø§Ù„Ø¨Ø­Ø«</div>
        </div>

        <!-- Subjects Tab -->
        <div id="subjectsTab">
            <div id="mainView">
                <div class="subjects-grid" id="subjectsGrid">
                    <div class="add-subject-btn" id="addSubjectBtn">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        <span style="font-size:1.125rem;">Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
                    </div>
                </div>
            </div>

            <div id="addSubjectForm" class="card hidden">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                    <h2>Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
                    <button id="closeSubjectForm" style="border:none;background:none;cursor:pointer;font-size:1.5rem;">Ã—</button>
                </div>
                <div style="display:flex;flex-direction:column;gap:1rem;">
                    <input type="text" id="subjectName" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©">
                    <input type="text" id="doctorName" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙƒØªÙˆØ±/Ø§Ù„Ø¯ÙƒØªÙˆØ±Ø©">
                    <div class="upload-area" id="uploadImageArea">
                        <div id="subjectImagePreview"></div>
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#9CA3AF" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        <p style="color:#6B7280;margin-top:0.5rem;">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø§Ø¯Ø©</p>
                        <input type="file" id="subjectImageInput" accept="image/*" class="hidden">
                    </div>
                    <button class="btn btn-primary" id="saveSubjectBtn">Ø­ÙØ¸ Ø§Ù„Ù…Ø§Ø¯Ø©</button>
                </div>
            </div>

            <div id="subjectView" class="card hidden"></div>
        </div>

        <!-- Exams Tab -->
        <div id="examsTab" class="hidden">
            <div class="card">
                <h2 style="margin-bottom:1.5rem;">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</h2>
                <div style="margin-bottom:2rem;padding:1.5rem;background:linear-gradient(135deg,#FEF3C7 0%,#DBEAFE 100%);border-radius:0.75rem;border:2px solid #FDE68A;">
                    <h3 style="margin-bottom:1rem;color:#1F2937;">ğŸ“¸ ØµÙˆØ± Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</h3>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1rem;">
                        <div>
                            <h4 style="font-size:.875rem;margin-bottom:.5rem;color:#6B7280;">ØµÙˆØ±Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙŠØ¯ ØªÙŠØ±Ù…</h4>
                            <div class="upload-area" id="midExamScheduleArea" style="min-height:150px;">
                                <div id="midExamSchedulePreview">ğŸ“¤ Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙŠØ¯ ØªÙŠØ±Ù…</div>
                                <input type="file" id="midExamScheduleInput" accept="image/*" class="hidden">
                            </div>
                        </div>
                        <div>
                            <h4 style="font-size:.875rem;margin-bottom:.5rem;color:#6B7280;">ØµÙˆØ±Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ§ÙŠÙ†Ø§Ù„</h4>
                            <div class="upload-area" id="finalExamScheduleArea" style="min-height:150px;">
                                <div id="finalExamSchedulePreview">ğŸ“¤ Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ§ÙŠÙ†Ø§Ù„</div>
                                <input type="file" id="finalExamScheduleInput" accept="image/*" class="hidden">
                            </div>
                        </div>
                    </div>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;">
                    <h3>Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠØ§Ù‹</h3>
                    <button class="add-exam-btn" id="addExamBtn">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù…ØªØ­Ø§Ù†</button>
                </div>
                <div id="addExamForm" class="hidden" style="margin-bottom:2rem;padding:1.5rem;background:#F9FAFB;border-radius:.75rem;">
                    <h3 style="margin-bottom:1rem;">Ø¥Ø¶Ø§ÙØ© Ø§Ù…ØªØ­Ø§Ù† Ø¬Ø¯ÙŠØ¯</h3>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1rem;">
                        <select id="examSubject" class="input"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option></select>
                        <select id="examType" class="input"><option value="mid">Ù…ÙŠØ¯ ØªÙŠØ±Ù…</option><option value="final">ÙØ§ÙŠÙ†Ø§Ù„</option></select>
                        <input type="date" id="examDate" class="input">
                        <input type="time" id="examTime" class="input">
                    </div>
                    <div style="display:flex;gap:.5rem;">
                        <button class="btn btn-primary" id="saveExamBtn">Ø­ÙØ¸</button>
                        <button class="btn" style="background:#6B7280;color:white;" id="cancelExamBtn">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                </div>
                <table class="exam-schedule-table" id="examTable">
                    <thead><tr><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>ØµÙˆØ±Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                    <tbody id="examTableBody"><tr><td colspan="6" style="text-align:center;color:#6B7280;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</td></tr></tbody>
                </table>
            </div>
        </div>

        <!-- Research Tab -->
        <div id="researchTab" class="hidden">
            <div class="card">
                <h2 style="margin-bottom:1.5rem;">Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆØ§Ø±Ø¯ Ø¯Ø±Ø§Ø³ÙŠØ©</h2>
                <div style="background:linear-gradient(135deg,#FEF3C7 0%,#FED7AA 100%);border-radius:1rem;padding:1.5rem;margin-bottom:2rem;border:2px solid #FDE68A;">
                    <h3 style="margin-bottom:1rem;color:#92400E;display:flex;align-items:center;gap:.5rem;">ğŸ’¾ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                    <p style="color:#78350F;margin-bottom:1rem;line-height:1.6;">Ø§Ø­Ù…Ù Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ù† Ø§Ù„Ø¶ÙŠØ§Ø¹! Ù‚Ù… Ø¨ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ù…ÙˆØ§Ø¯Ùƒ ÙˆÙ…Ø­Ø§Ø¶Ø±Ø§ØªÙƒ ÙˆØµÙˆØ±Ùƒ ÙÙŠ Ù…Ù„Ù ÙˆØ§Ø­Ø¯.</p>
                    <div style="display:flex;gap:.75rem;flex-wrap:wrap;">
                        <button id="exportDataBtn" style="background:linear-gradient(135deg,#10B981 0%,#059669 100%);color:white;border:none;padding:.875rem 1.5rem;border-radius:.75rem;cursor:pointer;font-weight:600;font-size:1rem;box-shadow:0 4px 15px rgba(16,185,129,.3);">ğŸ“¦ ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                        <button id="importDataBtn" style="background:linear-gradient(135deg,#3B82F6 0%,#6366F1 100%);color:white;border:none;padding:.875rem 1.5rem;border-radius:.75rem;cursor:pointer;font-weight:600;font-size:1rem;box-shadow:0 4px 15px rgba(59,130,246,.3);">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                        <input type="file" id="importFileInput" accept=".json" style="display:none;">
                    </div>
                </div>
                <input type="text" id="searchInput" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø§Ø¯Ø©ØŒ Ù…ÙˆØ¶ÙˆØ¹ØŒ Ø£Ùˆ Ø£ÙŠ Ø´ÙŠØ¡ ØªØ­ØªØ§Ø¬Ù‡...">
                <div id="searchResults">
                    <div id="searchResultsContent">
                        <h3 style="margin-bottom:1rem;color:#6B7280;">Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…ÙÙŠØ¯Ø© Ù„Ù„Ø¨Ø­Ø«:</h3>
                    </div>
                    <div class="research-card"><h3>ğŸ““ Notebook LM</h3><p>Ø£Ø¯Ø§Ø© Ø°ÙƒÙŠØ© Ù…Ù† Google Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p><div class="research-links"><a href="https://notebooklm.google.com" target="_blank" class="research-link">Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹</a></div></div>
                    <div class="research-card"><h3>ğŸŒ´ Jungle AI</h3><p>Ø¨Ø·Ø§Ù‚Ø§Øª ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø°ÙƒÙŠØ© Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p><div class="research-links"><a href="https://jungleai.com" target="_blank" class="research-link">Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹</a></div></div>
                    <div class="research-card"><h3>âœï¸ Ù…Ø­ÙˆÙ„ Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø©</h3><p>Ø£Ø¯Ø§Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†ØµÙˆØµ Ù…Ù† PDF Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„ØªØ¸Ù„ÙŠÙ„</p><div class="research-links"><a href="#" id="openTextConverterBtn" class="research-link">ÙØªØ­ Ø§Ù„Ø£Ø¯Ø§Ø©</a></div></div>
                    <div class="research-card"><h3>ğŸ–¼ï¸ Ù…Ø­ÙˆÙ„ Ø§Ù„ØµÙˆØ± Ø¥Ù„Ù‰ PDF</h3><p>Ø­ÙˆÙ‘Ù„ Ø§Ù„ØµÙˆØ± Ø¥Ù„Ù‰ Ù…Ù„Ù PDF ÙˆØ§Ø­Ø¯ Ø¨Ø³Ù‡ÙˆÙ„Ø©</p><div class="research-links"><a href="https://www.ilovepdf.com/jpg_to_pdf" target="_blank" class="research-link">ÙØªØ­ Ø§Ù„Ø£Ø¯Ø§Ø©</a></div></div>
                    <div class="research-card" style="background:linear-gradient(135deg,#DBEAFE 0%,#E0E7FF 100%);"><h3>ğŸ• Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</h3><p>Ø­Ø¯Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</p><div class="research-links"><a href="#" id="openOnlineLecturesBtn" class="research-link">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</a></div></div>
                    <div class="research-card"><h3>ğŸ“– Google Scholar</h3><p>Ù…Ø­Ø±Ùƒ Ø¨Ø­Ø« Ù„Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ø¹Ù„Ù…ÙŠØ© ÙˆØ§Ù„Ø£Ø¨Ø­Ø§Ø« Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©</p><div class="research-links"><a href="https://scholar.google.com" target="_blank" class="research-link">Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹</a></div></div>
                    <div class="research-card"><h3>ğŸ“ Wikipedia</h3><p>Ù…ÙˆØ³ÙˆØ¹Ø© Ø­Ø±Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</p><div class="research-links"><a href="https://ar.wikipedia.org" target="_blank" class="research-link">Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</a><a href="https://en.wikipedia.org" target="_blank" class="research-link">Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</a></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         BRV Modal â€” Better File Viewer
         4-Layer Fallback for Samsung / Huawei tablets
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="brv-modal" class="brv-modal" style="display:none;">
        <div class="brv-header">
            <span class="brv-title" id="brv-title">Ø§Ù„Ù…Ù„Ù</span>
            <div class="brv-actions">
                <button class="brv-btn brv-btn-dl" id="brv-download-btn">ğŸ“¥ ØªØ­Ù…ÙŠÙ„</button>
                <button class="brv-btn brv-btn-close" id="brv-close-btn">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
        <div class="brv-content" id="brv-content"></div>
    </div>

    <script>
        let subjects = [];
        let exams = [];
        let currentSubject = null;
        let newSubjectImage = null;
        let examScheduleImages = { mid: null, final: null };
        let onlineLectures = [];
        let notificationPermission = false;

        // PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const manifestData = { name:"Ù…Ù†Ø¸Ù… Ø§Ù„Ø¯Ø±Ø§Ø³Ø©", short_name:"Ù…Ù†Ø¸Ù… Ø§Ù„Ø¯Ø±Ø§Ø³Ø©", description:"Ù†Ø¸Ù… Ù…ÙˆØ§Ø¯Ùƒ ÙˆÙ…Ø­Ø§Ø¶Ø±Ø§ØªÙƒ Ø¨Ø³Ù‡ÙˆÙ„Ø©", start_url:"./", display:"standalone", background_color:"#ffffff", theme_color:"#3B82F6", orientation:"portrait", icons:[{ src:"https://hsynb7590-dev.github.io/Be-Regular-MNU-1/icon.png", sizes:"512x512", type:"image/png", purpose:"any maskable" }] };
                const manifestURL = URL.createObjectURL(new Blob([JSON.stringify(manifestData)], {type:'application/json'}));
                document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);
                const swCode = `const CACHE='so-v1';self.addEventListener('install',e=>e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./']))));self.addEventListener('fetch',e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)).catch(()=>caches.match('./'))));self.addEventListener('activate',e=>e.waitUntil(caches.keys().then(ks=>Promise.all(ks.filter(k=>k!==CACHE).map(k=>caches.delete(k))))));`;
                navigator.serviceWorker.register(URL.createObjectURL(new Blob([swCode],{type:'application/javascript'}))).catch(()=>{});
            });
        }

        // IndexedDB
        let db;
        const DB_NAME = 'StudyOrganizerDB';
        const DB_VERSION = 6;   // â† updated from 1 to 6

        function initDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, DB_VERSION);
                req.onerror = () => reject(req.error);
                req.onsuccess = () => { db = req.result; resolve(db); };
                req.onupgradeneeded = e => {
                    db = e.target.result;
                    ['subjects','exams','settings','lectures'].forEach(store => {
                        if (!db.objectStoreNames.contains(store)) {
                            db.createObjectStore(store, store === 'settings' ? undefined : { keyPath: 'id' });
                        }
                    });
                };
            });
        }

        async function saveToIndexedDB(storeName, data) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([storeName], 'readwrite');
                const store = tx.objectStore(storeName);
                if (Array.isArray(data)) { store.clear(); data.forEach(item => store.put(item)); }
                else { store.put(data, 'scheduleImages'); }
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        }

        async function loadFromIndexedDB(storeName) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([storeName], 'readonly');
                const req = tx.objectStore(storeName).getAll();
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }

        async function loadSettingsFromIndexedDB() {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['settings'], 'readonly');
                const req = tx.objectStore('settings').get('scheduleImages');
                req.onsuccess = () => resolve(req.result || { mid: null, final: null });
                req.onerror = () => reject(req.error);
            });
        }

        window.addEventListener('load', async () => {
            try {
                await initDB();
                const [savedSubjects, savedExams, savedScheduleImages, savedLectures] = await Promise.all([
                    loadFromIndexedDB('subjects'), loadFromIndexedDB('exams'),
                    loadSettingsFromIndexedDB(), loadFromIndexedDB('lectures')
                ]);
                subjects = savedSubjects.length ? savedSubjects : JSON.parse(localStorage.getItem('studyOrganizerData') || '[]');
                exams = savedExams.length ? savedExams : JSON.parse(localStorage.getItem('studyOrganizerExams') || '[]');
                examScheduleImages = (savedScheduleImages && (savedScheduleImages.mid || savedScheduleImages.final)) ? savedScheduleImages : JSON.parse(localStorage.getItem('studyOrganizerScheduleImages') || '{"mid":null,"final":null}');
                onlineLectures = savedLectures.length ? savedLectures : JSON.parse(localStorage.getItem('studyOrganizerLectures') || '[]');
                if (subjects.length) await saveData();
            } catch {
                subjects = JSON.parse(localStorage.getItem('studyOrganizerData') || '[]');
                exams = JSON.parse(localStorage.getItem('studyOrganizerExams') || '[]');
                examScheduleImages = JSON.parse(localStorage.getItem('studyOrganizerScheduleImages') || '{"mid":null,"final":null}');
                onlineLectures = JSON.parse(localStorage.getItem('studyOrganizerLectures') || '[]');
            }
            renderSubjects();
            updateExamSubjectDropdown();
            setupEventListeners();
            document.getElementById('openTextConverterBtn').addEventListener('click', e => { e.preventDefault(); openTextConverter(); });
            document.getElementById('openOnlineLecturesBtn').addEventListener('click', e => { e.preventDefault(); openOnlineLectures(); });
            document.getElementById('exportDataBtn').addEventListener('click', exportAllData);
            document.getElementById('importDataBtn').addEventListener('click', () => document.getElementById('importFileInput').click());
            document.getElementById('importFileInput').addEventListener('change', importAllData);
            document.getElementById('searchInput').addEventListener('input', handleSearch);
            checkUpcomingLectures();
            setInterval(checkUpcomingLectures, 60000);
        });

        function setupEventListeners() {
            document.getElementById('tab-subjects').addEventListener('click', () => switchTab('subjects'));
            document.getElementById('tab-exams').addEventListener('click', () => switchTab('exams'));
            document.getElementById('tab-research').addEventListener('click', () => switchTab('research'));
            document.getElementById('addSubjectBtn').addEventListener('click', showAddSubjectForm);
            document.getElementById('closeSubjectForm').addEventListener('click', hideAddSubjectForm);
            document.getElementById('saveSubjectBtn').addEventListener('click', saveSubject);
            document.getElementById('uploadImageArea').addEventListener('click', () => document.getElementById('subjectImageInput').click());
            document.getElementById('subjectImageInput').addEventListener('change', previewSubjectImage);
            document.getElementById('addExamBtn').addEventListener('click', showAddExamForm);
            document.getElementById('cancelExamBtn').addEventListener('click', hideAddExamForm);
            document.getElementById('saveExamBtn').addEventListener('click', addExamToSchedule);
            document.getElementById('midExamScheduleArea').addEventListener('click', () => document.getElementById('midExamScheduleInput').click());
            document.getElementById('finalExamScheduleArea').addEventListener('click', () => document.getElementById('finalExamScheduleInput').click());
            document.getElementById('midExamScheduleInput').addEventListener('change', e => handleScheduleImageUpload(e, 'mid'));
            document.getElementById('finalExamScheduleInput').addEventListener('change', e => handleScheduleImageUpload(e, 'final'));
        }

        function compressImage(b64, maxW = 800, q = 0.65) {
            return new Promise(res => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if (w > maxW) { h = h * maxW / w; w = maxW; }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    res(canvas.toDataURL('image/jpeg', q));
                };
                img.src = b64;
            });
        }

        async function saveData() {
            try {
                await Promise.all([
                    saveToIndexedDB('subjects', subjects),
                    saveToIndexedDB('exams', exams),
                    saveToIndexedDB('settings', examScheduleImages),
                    saveToIndexedDB('lectures', onlineLectures)
                ]);
            } catch (err) {
                console.error('Save error:', err);
            }
        }

        window.addEventListener('beforeunload', () => saveData());
        setInterval(() => saveData(), 180000);

        function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            ['subjectsTab','examsTab','researchTab'].forEach(id => document.getElementById(id).classList.add('hidden'));
            if (tab === 'subjects') document.getElementById('subjectsTab').classList.remove('hidden');
            else if (tab === 'exams') { document.getElementById('examsTab').classList.remove('hidden'); renderExamSchedule(); renderScheduleImages(); }
            else document.getElementById('researchTab').classList.remove('hidden');
        }

        function showAddSubjectForm() { document.getElementById('addSubjectForm').classList.remove('hidden'); document.getElementById('mainView').classList.add('hidden'); }
        function hideAddSubjectForm() {
            document.getElementById('addSubjectForm').classList.add('hidden');
            document.getElementById('mainView').classList.remove('hidden');
            document.getElementById('subjectName').value = '';
            document.getElementById('doctorName').value = '';
            document.getElementById('subjectImagePreview').innerHTML = '';
            newSubjectImage = null;
        }

        async function previewSubjectImage(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async ev => {
                newSubjectImage = await compressImage(ev.target.result, 500, 0.65);
                document.getElementById('subjectImagePreview').innerHTML = `<img src="${newSubjectImage}" style="max-width:200px;border-radius:50%;">`;
            };
            reader.readAsDataURL(file);
        }

        function saveSubject() {
            const name = document.getElementById('subjectName').value.trim();
            const doctor = document.getElementById('doctorName').value.trim();
            if (!name || !doctor) { alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆØ§Ø³Ù… Ø§Ù„Ø¯ÙƒØªÙˆØ±'); return; }
            subjects.push({ id: Date.now(), name, doctor, image: newSubjectImage, weeks: [], practicalExam: null, oralExam: null, doctorQuestions: null, doctorQuestionsName: null, additionalDoctorFiles: [], myQuestions: '', questionImages: [] });
            saveData(); renderSubjects(); updateExamSubjectDropdown(); hideAddSubjectForm();
        }

        function renderSubjects() {
            const grid = document.getElementById('subjectsGrid');
            const addBtn = grid.querySelector('.add-subject-btn');
            grid.innerHTML = '';
            subjects.forEach(s => {
                const card = document.createElement('div');
                card.className = 'subject-card';
                card.innerHTML = `<div class="subject-header">${s.image ? `<img src="${s.image}" class="subject-image">` : ''}<div class="subject-info" style="flex:1;"><h3>${s.name}</h3><p>Ø¯. ${s.doctor}</p><p style="color:#3B82F6;font-size:.75rem;">${s.weeks.length} Ø£Ø³Ø¨ÙˆØ¹</p></div><button class="delete-btn" data-id="${s.id}">ğŸ—‘ï¸</button></div>`;
                card.querySelector('.delete-btn').addEventListener('click', ev => { ev.stopPropagation(); deleteSubject(s.id); });
                card.addEventListener('click', () => showSubjectDetail(s.id));
                grid.appendChild(card);
            });
            grid.appendChild(addBtn);
        }

        async function deleteSubject(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø©ØŸ')) return;
            subjects = subjects.filter(s => s.id !== id);
            exams = exams.filter(e => e.subjectId !== id);
            await saveData(); renderSubjects(); updateExamSubjectDropdown();
        }

        function showSubjectDetail(id) {
            currentSubject = subjects.find(s => s.id === id);
            document.getElementById('mainView').classList.add('hidden');
            const view = document.getElementById('subjectView');
            view.classList.remove('hidden');
            view.innerHTML = `
                <span class="back-btn" id="backToMainBtn">â† Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù…ÙˆØ§Ø¯</span>
                <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem;">
                    ${currentSubject.image ? `<img src="${currentSubject.image}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:4px solid #BFDBFE;">` : ''}
                    <div><h2 style="font-size:1.5rem;margin-bottom:.25rem;">${currentSubject.name}</h2><p style="color:#6B7280;">Ø¯. ${currentSubject.doctor}</p></div>
                </div>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem;margin-bottom:1.5rem;">
                    <div class="upload-area" id="practicalExamArea"><h3 style="font-size:.875rem;margin-bottom:.5rem;">ØµÙˆØ±Ø© Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠ</h3><div id="practicalExamPreview">${currentSubject.practicalExam ? `<div class="upload-preview"><img src="${currentSubject.practicalExam}" style="max-width:100%;"><button class="delete-btn" id="deletePracticalBtn" style="position:absolute;top:.5rem;left:.5rem;">Ã—</button></div>` : 'ğŸ“¤'}</div><input type="file" id="practicalExamInput" accept="image/*" class="hidden"></div>
                    <div class="upload-area" id="oralExamArea"><h3 style="font-size:.875rem;margin-bottom:.5rem;">ØµÙˆØ±Ø© Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø´ÙÙˆÙŠ</h3><div id="oralExamPreview">${currentSubject.oralExam ? `<div class="upload-preview"><img src="${currentSubject.oralExam}" style="max-width:100%;"><button class="delete-btn" id="deleteOralBtn" style="position:absolute;top:.5rem;left:.5rem;">Ã—</button></div>` : 'ğŸ“¤'}</div><input type="file" id="oralExamInput" accept="image/*" class="hidden"></div>
                </div>
                <div style="margin-bottom:1.5rem;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;"><h3>Ù…Ù„Ù Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¯ÙƒØªÙˆØ±</h3>${currentSubject.doctorQuestions ? `<button class="btn" style="background:linear-gradient(135deg,#8B5CF6 0%,#EC4899 100%);color:white;padding:.4rem .8rem;font-size:.75rem;border-radius:.5rem;" id="addDoctorQuestionFileBtn">+ Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ù</button>` : ''}</div>
                    <div class="upload-area" id="doctorQuestionsArea"><div id="doctorQuestionsPreview">${currentSubject.doctorQuestions ? `<div style="text-align:center;"><div style="color:#10B981;font-size:2rem;">âœ“</div><div class="file-name" style="margin-top:.5rem;">${currentSubject.doctorQuestionsName}</div><button class="file-open-btn" id="openDoctorQuestionsBtn">ÙØªØ­ Ø§Ù„Ù…Ù„Ù</button></div>` : 'ğŸ“¤ Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ù…Ù„Ù PDF'}</div><input type="file" id="doctorQuestionsInput" accept=".pdf" class="hidden"></div>
                    ${currentSubject.additionalDoctorFiles && currentSubject.additionalDoctorFiles.length > 0 ? `<div style="margin-top:1rem;display:grid;gap:.5rem;">${currentSubject.additionalDoctorFiles.map((f,i) => `<div style="background:white;border:2px solid #E5E7EB;border-radius:.5rem;padding:.75rem;display:flex;align-items:center;justify-content:space-between;"><div style="flex:1;display:flex;align-items:center;gap:.5rem;"><span style="color:#10B981;font-size:1.2rem;">ğŸ“„</span><span class="file-name" style="flex:1;">${f.name}</span></div><div style="display:flex;gap:.5rem;"><button class="file-open-btn open-additional-file" data-week-id="" data-file-idx="${i}" data-file-type="doctor">ÙØªØ­</button><button class="delete-btn delete-additional-file" data-file-idx="${i}" data-file-type="doctor" style="position:static;width:28px;height:28px;font-size:.9rem;">Ã—</button></div></div>`).join('')}</div>` : ''}
                </div>
                <div style="margin-bottom:1.5rem;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;"><h3>Ø£Ø³Ø¦Ù„ØªÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</h3><button class="btn" style="background:linear-gradient(135deg,#8B5CF6 0%,#EC4899 100%);color:white;padding:.5rem 1rem;" id="captureQuestionBtn">ğŸ“¸ Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ù„Ù„Ø³Ø¤Ø§Ù„</button></div>
                    <textarea class="textarea" id="myQuestions" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù„ÙŠ Ù…Ø´ ÙØ§Ù‡Ù…Ù‡Ø§...">${currentSubject.myQuestions}</textarea>
                    <input type="file" id="questionImageInput" accept="image/*" capture="environment" class="hidden">
                    <div id="questionImagesContainer" style="display:grid;grid-template-columns:repeat(2,1fr);gap:.5rem;margin-top:1rem;">${currentSubject.questionImages ? currentSubject.questionImages.map((img,i) => `<div style="position:relative;"><img src="${img}" style="width:100%;border-radius:.5rem;border:2px solid #E5E7EB;"><button class="delete-btn" data-img-index="${i}" style="position:absolute;top:.25rem;left:.25rem;">Ã—</button></div>`).join('') : ''}</div>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                    <h3>Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</h3>
                    <div style="display:flex;gap:.5rem;">
                        <button class="btn btn-primary" id="addWeekBtn">â• Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¨ÙˆØ¹</button>
                        <button class="btn" style="background:linear-gradient(135deg,#10B981 0%,#059669 100%);color:white;" id="saveChangesBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                    </div>
                </div>
                <div id="weeksList"></div>`;

            document.getElementById('backToMainBtn').addEventListener('click', backToMain);
            if (document.getElementById('deletePracticalBtn')) document.getElementById('deletePracticalBtn').addEventListener('click', e => { e.stopPropagation(); deleteExamImage('practical'); });
            if (document.getElementById('deleteOralBtn')) document.getElementById('deleteOralBtn').addEventListener('click', e => { e.stopPropagation(); deleteExamImage('oral'); });
            document.getElementById('practicalExamArea').addEventListener('click', () => document.getElementById('practicalExamInput').click());
            document.getElementById('oralExamArea').addEventListener('click', () => document.getElementById('oralExamInput').click());
            document.getElementById('doctorQuestionsArea').addEventListener('click', () => document.getElementById('doctorQuestionsInput').click());
            if (document.getElementById('openDoctorQuestionsBtn')) document.getElementById('openDoctorQuestionsBtn').addEventListener('click', e => { e.stopPropagation(); openFile(currentSubject.doctorQuestions, currentSubject.doctorQuestionsName); });
            document.getElementById('practicalExamInput').addEventListener('change', e => handleExamUpload(e, 'practical'));
            document.getElementById('oralExamInput').addEventListener('change', e => handleExamUpload(e, 'oral'));
            document.getElementById('doctorQuestionsInput').addEventListener('change', handleDoctorQuestions);
            if (document.getElementById('addDoctorQuestionFileBtn')) document.getElementById('addDoctorQuestionFileBtn').addEventListener('click', e => { e.stopPropagation(); document.getElementById('doctorQuestionsInput').click(); });
            document.getElementById('myQuestions').addEventListener('input', e => { currentSubject.myQuestions = e.target.value; });
            document.getElementById('captureQuestionBtn').addEventListener('click', () => document.getElementById('questionImageInput').click());
            document.getElementById('questionImageInput').addEventListener('change', handleQuestionImageUpload);
            document.getElementById('addWeekBtn').addEventListener('click', addWeek);
            document.getElementById('saveChangesBtn').addEventListener('click', saveSubjectChanges);
            document.querySelectorAll('#questionImagesContainer .delete-btn').forEach(btn => btn.addEventListener('click', function() { deleteQuestionImage(parseInt(this.getAttribute('data-img-index'))); }));

            // Additional doctor files
            document.querySelectorAll('.open-additional-file[data-file-type="doctor"]').forEach(btn => {
                btn.addEventListener('click', e => { e.stopPropagation(); const f = currentSubject.additionalDoctorFiles[parseInt(btn.getAttribute('data-file-idx'))]; openFile(f.data, f.name); });
            });
            document.querySelectorAll('.delete-additional-file[data-file-type="doctor"]').forEach(btn => {
                btn.addEventListener('click', e => { e.stopPropagation(); deleteAdditionalDoctorFile(parseInt(btn.getAttribute('data-file-idx'))); });
            });
            renderWeeks();
        }

        async function handleExamUpload(e, type) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async ev => {
                const compressed = await compressImage(ev.target.result, 700, 0.65);
                currentSubject[`${type}Exam`] = compressed;
                await saveData();
                const pid = type === 'practical' ? 'practicalExamPreview' : 'oralExamPreview';
                const bid = `delete${type === 'practical' ? 'Practical' : 'Oral'}Btn`;
                document.getElementById(pid).innerHTML = `<div class="upload-preview"><img src="${compressed}" style="max-width:100%;"><button class="delete-btn" id="${bid}" style="position:absolute;top:.5rem;left:.5rem;">Ã—</button></div>`;
                document.getElementById(bid).addEventListener('click', ev2 => { ev2.stopPropagation(); deleteExamImage(type); });
                showNotification('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ“');
            };
            reader.readAsDataURL(file);
        }

        async function deleteExamImage(type) {
            currentSubject[`${type}Exam`] = null;
            await saveData();
            document.getElementById(type === 'practical' ? 'practicalExamPreview' : 'oralExamPreview').innerHTML = 'ğŸ“¤';
            showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ“');
        }

        async function handleDoctorQuestions(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async ev => {
                if (!currentSubject.doctorQuestions) { currentSubject.doctorQuestions = ev.target.result; currentSubject.doctorQuestionsName = file.name; }
                else { if (!currentSubject.additionalDoctorFiles) currentSubject.additionalDoctorFiles = []; currentSubject.additionalDoctorFiles.push({ name: file.name, data: ev.target.result }); }
                await saveData();
                showSubjectDetail(currentSubject.id);
                showNotification('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­ âœ“');
            };
            reader.readAsDataURL(file);
        }

        async function deleteAdditionalDoctorFile(idx) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„ÙØŸ')) return;
            currentSubject.additionalDoctorFiles.splice(idx, 1);
            await saveData(); showSubjectDetail(currentSubject.id); showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­ âœ“');
        }

        function addWeek() {
            currentSubject.weeks.push({ id: Date.now(), number: currentSubject.weeks.length + 1, lectureSummary: null, lectureSummaryName: null, sectionSummary: null, sectionSummaryName: null, questions: null, questionsName: null, salawatCount: 0, lectureImages: [], sectionImages: [], additionalLectureFiles: [], additionalSectionFiles: [], additionalQuestionsFiles: [] });
            updateSubject(); renderWeeks();
        }

        function renderWeeks() {
            const list = document.getElementById('weeksList');
            list.innerHTML = '';
            currentSubject.weeks.forEach(week => {
                const wc = document.createElement('div');
                wc.className = 'week-card';

                const makeFileSlot = (label, fileKey, nameKey, inputId, addType) => `
                    <div style="position:relative;">
                        <div class="file-upload" data-week="${week.id}" data-type="${fileKey}">
                            <p style="font-size:.75rem;margin-bottom:.5rem;">${label}</p>
                            ${week[fileKey] ? `<div class="file-uploaded"><div style="color:#10B981;font-size:1.5rem;">âœ“</div><div class="file-name">${week[nameKey]}</div><button class="file-open-btn" data-file="${week[fileKey]}" data-name="${week[nameKey]}">ÙØªØ­</button></div>` : 'ğŸ“¤'}
                            <input type="file" id="${inputId}_${week.id}" accept=".pdf" class="hidden">
                        </div>
                        ${week[fileKey] ? `<button class="btn" style="position:absolute;top:-8px;left:-8px;background:linear-gradient(135deg,#8B5CF6 0%,#EC4899 100%);color:white;padding:.3rem .5rem;font-size:.7rem;border-radius:.4rem;box-shadow:0 2px 8px rgba(139,92,246,.4);z-index:10;" data-add-file="${addType}" data-wid="${week.id}">+</button>` : ''}
                    </div>`;

                const makeAdditionalFiles = (arr, type, colorHex, icon) => arr && arr.length ? `
                    <div style="margin-top:1rem;padding-top:1rem;border-top:2px solid #D1FAE5;">
                        <h5 style="margin:0 0 .5rem 0;font-size:.8rem;color:#6B7280;">Ù…Ù„ÙØ§Øª Ø¥Ø¶Ø§ÙÙŠØ© - ${type === 'lecture' ? 'Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©' : type === 'section' ? 'Ù…Ù„Ø®Øµ Ø§Ù„Ø³ÙƒØ´Ù†' : 'Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©'}</h5>
                        <div style="display:grid;gap:.5rem;">${arr.map((f,i) => `<div style="background:white;border:2px solid #E5E7EB;border-radius:.5rem;padding:.5rem;display:flex;align-items:center;justify-content:space-between;"><div style="flex:1;display:flex;align-items:center;gap:.5rem;"><span style="color:${colorHex};font-size:1rem;">${icon}</span><span class="file-name" style="flex:1;font-size:.7rem;">${f.name}</span></div><div style="display:flex;gap:.25rem;"><button class="file-open-btn brv-open-add" data-wid="${week.id}" data-fidx="${i}" data-ftype="${type}">ÙØªØ­</button><button class="delete-btn brv-del-add" data-wid="${week.id}" data-fidx="${i}" data-ftype="${type}" style="position:static;width:22px;height:22px;font-size:.8rem;">Ã—</button></div></div>`).join('')}</div>
                    </div>` : '';

                wc.innerHTML = `
                    <div class="week-header">
                        <h4>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${week.number}</h4>
                        <span style="color:#10B981;font-size:.875rem;cursor:pointer;" class="salawat-btn" data-week="${week.id}">ØµÙ„ÙÙ‘ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¨ÙŠ ï·º${week.salawatCount ? ` (${week.salawatCount})` : ''}</span>
                    </div>
                    <div class="week-files">
                        ${makeFileSlot('Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©','lectureSummary','lectureSummaryName','lecture','lecture')}
                        ${makeFileSlot('Ù…Ù„Ø®Øµ Ø§Ù„Ø³ÙƒØ´Ù†','sectionSummary','sectionSummaryName','section','section')}
                        ${makeFileSlot('Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©','questions','questionsName','questions','questions')}
                    </div>
                    ${makeAdditionalFiles(week.additionalLectureFiles,'lecture','#8B5CF6','ğŸ“„')}
                    ${makeAdditionalFiles(week.additionalSectionFiles,'section','#F59E0B','ğŸ“„')}
                    ${makeAdditionalFiles(week.additionalQuestionsFiles,'questions','#10B981','ğŸ“„')}
                    <div style="margin-top:1rem;padding-top:1rem;border-top:2px solid #D1FAE5;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem;"><h5 style="margin:0;font-size:.875rem;">ğŸ“¸ ØµÙˆØ± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</h5><button class="btn" style="background:linear-gradient(135deg,#8B5CF6 0%,#EC4899 100%);color:white;padding:.4rem .8rem;font-size:.75rem;border-radius:.5rem;" data-add-lecture-img="${week.id}">+ Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø©</button></div>
                        <div id="lectureImages_${week.id}" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:.5rem;">${week.lectureImages && week.lectureImages.length ? week.lectureImages.map((img,i) => `<div style="position:relative;border-radius:.5rem;overflow:hidden;border:2px solid #E5E7EB;"><img src="${img}" style="width:100%;height:100px;object-fit:cover;cursor:pointer;" onclick="viewWeekImage(${week.id},'lecture',${i})"><button class="delete-btn" style="position:absolute;top:.25rem;left:.25rem;width:24px;height:24px;font-size:.9rem;" data-delete-lecture-img="${week.id}" data-img-idx="${i}">Ã—</button></div>`).join('') : '<p style="text-align:center;color:#9CA3AF;font-size:.75rem;padding:1rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±</p>'}</div>
                        <input type="file" id="lectureImageInput_${week.id}" accept="image/*" class="hidden" multiple>
                    </div>
                    <div style="margin-top:1rem;padding-top:1rem;border-top:2px solid #D1FAE5;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem;"><h5 style="margin:0;font-size:.875rem;">ğŸ“¸ ØµÙˆØ± Ø§Ù„Ø³ÙƒØ´Ù†</h5><button class="btn" style="background:linear-gradient(135deg,#F59E0B 0%,#D97706 100%);color:white;padding:.4rem .8rem;font-size:.75rem;border-radius:.5rem;" data-add-section-img="${week.id}">+ Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø©</button></div>
                        <div id="sectionImages_${week.id}" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:.5rem;">${week.sectionImages && week.sectionImages.length ? week.sectionImages.map((img,i) => `<div style="position:relative;border-radius:.5rem;overflow:hidden;border:2px solid #E5E7EB;"><img src="${img}" style="width:100%;height:100px;object-fit:cover;cursor:pointer;" onclick="viewWeekImage(${week.id},'section',${i})"><button class="delete-btn" style="position:absolute;top:.25rem;left:.25rem;width:24px;height:24px;font-size:.9rem;" data-delete-section-img="${week.id}" data-img-idx="${i}">Ã—</button></div>`).join('') : '<p style="text-align:center;color:#9CA3AF;font-size:.75rem;padding:1rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±</p>'}</div>
                        <input type="file" id="sectionImageInput_${week.id}" accept="image/*" class="hidden" multiple>
                    </div>`;
                list.appendChild(wc);
            });

            // File upload slots
            document.querySelectorAll('.file-upload').forEach(el => el.addEventListener('click', function() {
                const wid = this.dataset.week, type = this.dataset.type;
                const inputId = type === 'lectureSummary' ? `lecture_${wid}` : type === 'sectionSummary' ? `section_${wid}` : `questions_${wid}`;
                document.getElementById(inputId).click();
            }));
            currentSubject.weeks.forEach(w => {
                const makeListener = (inputId, fileKey) => { const el = document.getElementById(inputId); if (el) el.addEventListener('change', e => handleWeekFileUpload(e, w.id, fileKey)); };
                makeListener(`lecture_${w.id}`, 'lectureSummary');
                makeListener(`section_${w.id}`, 'sectionSummary');
                makeListener(`questions_${w.id}`, 'questions');
                const li = document.getElementById(`lectureImageInput_${w.id}`); if (li) li.addEventListener('change', e => handleWeekImagesUpload(e, w.id, 'lecture'));
                const si = document.getElementById(`sectionImageInput_${w.id}`); if (si) si.addEventListener('change', e => handleWeekImagesUpload(e, w.id, 'section'));
            });

            // Open file buttons
            document.querySelectorAll('.file-open-btn[data-file]').forEach(btn => btn.addEventListener('click', e => { e.stopPropagation(); openFile(btn.dataset.file, btn.dataset.name); }));

            // Salawat
            document.querySelectorAll('.salawat-btn').forEach(btn => btn.addEventListener('click', function() { incrementSalawat(parseInt(this.dataset.week)); }));

            // Add image buttons
            document.querySelectorAll('[data-add-lecture-img]').forEach(btn => btn.addEventListener('click', e => { e.stopPropagation(); document.getElementById(`lectureImageInput_${btn.dataset.addLectureImg}`).click(); }));
            document.querySelectorAll('[data-add-section-img]').forEach(btn => btn.addEventListener('click', e => { e.stopPropagation(); document.getElementById(`sectionImageInput_${btn.dataset.addSectionImg}`).click(); }));

            // Delete image buttons
            document.querySelectorAll('[data-delete-lecture-img]').forEach(btn => btn.addEventListener('click', e => { e.stopPropagation(); deleteWeekImage(parseInt(btn.dataset.deleteLectureImg), 'lecture', parseInt(btn.dataset.imgIdx)); }));
            document.querySelectorAll('[data-delete-section-img]').forEach(btn => btn.addEventListener('click', e => { e.stopPropagation(); deleteWeekImage(parseInt(btn.dataset.deleteSectionImg), 'section', parseInt(btn.dataset.imgIdx)); }));

            // Add additional file buttons
            document.querySelectorAll('[data-add-file]').forEach(btn => btn.addEventListener('click', e => { e.stopPropagation(); addAdditionalFile(parseInt(btn.dataset.wid), btn.dataset.addFile); }));

            // Open/delete additional files
            document.querySelectorAll('.brv-open-add').forEach(btn => btn.addEventListener('click', e => {
                e.stopPropagation();
                const w = currentSubject.weeks.find(x => x.id === parseInt(btn.dataset.wid));
                const arr = btn.dataset.ftype === 'lecture' ? w.additionalLectureFiles : btn.dataset.ftype === 'section' ? w.additionalSectionFiles : w.additionalQuestionsFiles;
                const f = arr[parseInt(btn.dataset.fidx)];
                if (f) openFile(f.data, f.name);
            }));
            document.querySelectorAll('.brv-del-add').forEach(btn => btn.addEventListener('click', e => {
                e.stopPropagation();
                deleteAdditionalWeekFile(parseInt(btn.dataset.wid), btn.dataset.ftype, parseInt(btn.dataset.fidx));
            }));
        }

        function addAdditionalFile(weekId, type) {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = '.pdf';
            input.onchange = async e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async ev => {
                    const week = currentSubject.weeks.find(w => w.id === weekId);
                    const key = type === 'lecture' ? 'additionalLectureFiles' : type === 'section' ? 'additionalSectionFiles' : 'additionalQuestionsFiles';
                    if (!week[key]) week[key] = [];
                    week[key].push({ name: file.name, data: ev.target.result });
                    await saveData(); showNotification('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­ âœ“');
                    showSubjectDetail(currentSubject.id);
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        async function deleteAdditionalWeekFile(weekId, type, idx) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„ÙØŸ')) return;
            const week = currentSubject.weeks.find(w => w.id === weekId);
            const key = type === 'lecture' ? 'additionalLectureFiles' : type === 'section' ? 'additionalSectionFiles' : 'additionalQuestionsFiles';
            week[key].splice(idx, 1);
            await saveData(); renderWeeks(); showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­ âœ“');
        }

        async function incrementSalawat(weekId) {
            const week = currentSubject.weeks.find(w => w.id === weekId);
            if (!week.salawatCount) week.salawatCount = 0;
            week.salawatCount++;
            await saveData();
            const btn = document.querySelector(`.salawat-btn[data-week="${weekId}"]`);
            btn.textContent = `ØµÙ„ÙÙ‘ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¨ÙŠ ï·º (${week.salawatCount})`;
            btn.style.transform = 'scale(1.2)'; btn.style.color = '#059669';
            setTimeout(() => { btn.style.transform = 'scale(1)'; btn.style.color = '#10B981'; }, 200);
        }

        async function handleQuestionImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async ev => {
                const compressed = await compressImage(ev.target.result, 700, 0.6);
                if (!currentSubject.questionImages) currentSubject.questionImages = [];
                currentSubject.questionImages.push(compressed);
                await saveData();
                const container = document.getElementById('questionImagesContainer');
                const div = document.createElement('div');
                div.style.position = 'relative';
                div.innerHTML = `<img src="${compressed}" style="width:100%;border-radius:.5rem;border:2px solid #E5E7EB;"><button class="delete-btn" data-img-index="${currentSubject.questionImages.length-1}" style="position:absolute;top:.25rem;left:.25rem;">Ã—</button>`;
                div.querySelector('.delete-btn').addEventListener('click', function() { deleteQuestionImage(parseInt(this.dataset.imgIndex)); });
                container.appendChild(div);
                showNotification('ØªÙ… Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­ âœ“');
            };
            reader.readAsDataURL(file);
        }

        async function deleteQuestionImage(idx) {
            currentSubject.questionImages.splice(idx, 1);
            await saveData();
            const c = document.getElementById('questionImagesContainer');
            c.innerHTML = currentSubject.questionImages.map((img,i) => `<div style="position:relative;"><img src="${img}" style="width:100%;border-radius:.5rem;border:2px solid #E5E7EB;"><button class="delete-btn" data-img-index="${i}" style="position:absolute;top:.25rem;left:.25rem;">Ã—</button></div>`).join('');
            c.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', function() { deleteQuestionImage(parseInt(this.dataset.imgIndex)); }));
            showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ“');
        }

        async function handleWeekImagesUpload(e, weekId, type) {
            const files = e.target.files;
            if (!files || !files.length) return;
            const week = currentSubject.weeks.find(w => w.id === weekId);
            const key = type === 'lecture' ? 'lectureImages' : 'sectionImages';
            if (!week[key]) week[key] = [];
            showNotification('Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±...');
            for (const file of files) {
                const reader = new FileReader();
                await new Promise(res => {
                    reader.onload = async ev => { week[key].push(await compressImage(ev.target.result, 700, 0.6)); res(); };
                    reader.readAsDataURL(file);
                });
            }
            await saveData(); renderWeeks();
        }

        async function deleteWeekImage(weekId, type, idx) {
            const week = currentSubject.weeks.find(w => w.id === weekId);
            const key = type === 'lecture' ? 'lectureImages' : 'sectionImages';
            if (week && week[key]) { week[key].splice(idx, 1); await saveData(); renderWeeks(); showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ“'); }
        }

        function viewWeekImage(weekId, type, idx) {
            const week = currentSubject.weeks.find(w => w.id === weekId);
            const key = type === 'lecture' ? 'lectureImages' : 'sectionImages';
            if (!week || !week[key] || !week[key][idx]) return;
            // Use BRV modal for image viewing too
            brvCurrentFile = { data: week[key][idx], name: `ØµÙˆØ±Ø©_${type}_${idx+1}.jpg` };
            showBRVModal(brvCurrentFile.name);
            brvShowImage(week[key][idx]);
        }

        async function saveSubjectChanges() { await saveData(); showNotification('ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ“', 2000); }

        function showNotification(msg, dur = 1500) {
            const ex = document.getElementById('notification');
            if (ex) ex.remove();
            const n = document.createElement('div');
            n.id = 'notification';
            n.textContent = msg;
            n.style.cssText = 'position:fixed;top:2rem;right:2rem;background:linear-gradient(135deg,#10B981 0%,#059669 100%);color:white;padding:1rem 1.5rem;border-radius:.75rem;box-shadow:0 10px 25px rgba(0,0,0,.2);z-index:20000;font-weight:600;animation:slideIn .3s ease-out;';
            document.body.appendChild(n);
            setTimeout(() => { n.style.animation = 'slideOut .3s ease-out'; setTimeout(() => n.remove(), 300); }, dur);
        }

        const _styleAnim = document.createElement('style');
        _styleAnim.textContent = '@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}@keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}';
        document.head.appendChild(_styleAnim);

        async function handleWeekFileUpload(e, weekId, type) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async ev => {
                const week = currentSubject.weeks.find(w => w.id === weekId);
                week[type] = ev.target.result;
                week[type + 'Name'] = file.name;
                await saveData(); renderWeeks(); showNotification('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­ âœ“');
            };
            reader.readAsDataURL(file);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BRV â€” Better File Viewer  |  4-Layer Fallback Chain
        // Fixes PDF/image opening on Samsung & Huawei tablets
        // Layer 1 â†’ PDF.js canvas  |  Layer 2 â†’ blob iframe
        // Layer 3 â†’ base64 object  |  Layer 4 â†’ native download <a>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        let brvCurrentFile = { data: null, name: null };

        /** Convert a data-URI to a Blob */
        function brvDataURItoBlob(dataURI) {
            const parts = dataURI.split(',');
            const mime  = parts[0].split(':')[1].split(';')[0];
            const raw   = atob(parts[1]);
            const arr   = new Uint8Array(raw.length);
            for (let i = 0; i < raw.length; i++) arr[i] = raw.charCodeAt(i);
            return new Blob([arr], { type: mime });
        }

        /** Show the BRV modal with a spinner and wire up close/download buttons */
        function showBRVModal(fileName) {
            brvCurrentFile.name = fileName;
            const modal = document.getElementById('brv-modal');
            document.getElementById('brv-title').textContent = fileName;
            document.getElementById('brv-content').innerHTML =
                '<div class="brv-loading"><div class="brv-spinner"></div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</p></div>';
            modal.style.display = 'flex';

            document.getElementById('brv-close-btn').onclick = () => {
                modal.style.display = 'none';
                document.getElementById('brv-content').innerHTML = '';
            };
            document.getElementById('brv-download-btn').onclick = () =>
                brvLayer4Download(brvCurrentFile.data, brvCurrentFile.name);
        }

        /** Main entry point â€” replaces old openFile() */
        async function openFile(fileData, fileName) {
            if (!fileData || !fileName) return;
            brvCurrentFile = { data: fileData, name: fileName };

            const isImg = /\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(fileName) ||
                          /^data:image\//i.test(fileData);
            const isPDF = /\.pdf$/i.test(fileName) ||
                          /^data:application\/pdf/i.test(fileData);

            showBRVModal(fileName);

            if (isImg) {
                brvShowImage(fileData);
            } else if (isPDF) {
                await brvLayer1PDF(fileData, fileName);
            } else {
                // Unknown type â†’ go straight to native download
                brvLayer4Download(fileData, fileName);
            }
        }

        /** Display an image directly inside the modal */
        function brvShowImage(fileData) {
            document.getElementById('brv-content').innerHTML =
                `<img src="${fileData}" style="max-width:100%;display:block;margin:auto;border-radius:8px;">`;
        }

        /** LAYER 1 â€” Render PDF pages as <canvas> via PDF.js */
        async function brvLayer1PDF(fileData, fileName) {
            const container = document.getElementById('brv-content');
            container.innerHTML =
                '<div class="brv-loading"><div class="brv-spinner"></div><p>Ø§Ù„Ø·Ø¨Ù‚Ø© 1: PDF.js</p><span class="brv-layer-badge">canvas rendering</span></div>';
            try {
                // Lazy-load PDF.js only once
                if (!window.pdfjsLib) {
                    await new Promise((res, rej) => {
                        const s = document.createElement('script');
                        s.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
                        s.onload = () => {
                            window.pdfjsLib.GlobalWorkerOptions.workerSrc =
                                'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                            res();
                        };
                        s.onerror = rej;
                        document.head.appendChild(s);
                    });
                }

                const pdf = await window.pdfjsLib.getDocument(fileData).promise;
                container.innerHTML = `<div class="brv-page-count">ğŸ“„ ${pdf.numPages} ØµÙØ­Ø©</div>`;

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const vp   = page.getViewport({ scale: 1.5 });
                    const canvas = document.createElement('canvas');
                    canvas.width  = vp.width;
                    canvas.height = vp.height;
                    canvas.className = 'brv-page-canvas';
                    await page.render({ canvasContext: canvas.getContext('2d'), viewport: vp }).promise;
                    container.appendChild(canvas);
                }
            } catch (e) {
                console.warn('BRV L1 (PDF.js) failed â†’', e);
                await brvLayer2Iframe(fileData, fileName);
            }
        }

        /** LAYER 2 â€” Blob URL inside an <iframe> */
        async function brvLayer2Iframe(fileData, fileName) {
            const container = document.getElementById('brv-content');
            container.innerHTML =
                '<div class="brv-loading"><div class="brv-spinner"></div><p>Ø§Ù„Ø·Ø¨Ù‚Ø© 2: iframe</p><span class="brv-layer-badge">blob URL</span></div>';
            let blobURL = null;
            try {
                blobURL = URL.createObjectURL(brvDataURItoBlob(fileData));
                container.innerHTML = `<iframe id="brv-iframe" src="${blobURL}" class="brv-iframe"></iframe>`;

                // Give the iframe 3 s to paint; cross-origin check is impossible on some devices
                await new Promise(r => setTimeout(r, 3000));

                const iframe = document.getElementById('brv-iframe');
                // Heuristic: if contentDocument is null the browser sandboxed it out
                const painted = iframe && iframe.contentDocument !== null;

                if (!painted) {
                    if (blobURL) URL.revokeObjectURL(blobURL);
                    await brvLayer3Base64(fileData, fileName);
                } else {
                    // Success â€” revoke after a minute
                    setTimeout(() => { if (blobURL) URL.revokeObjectURL(blobURL); }, 60000);
                }
            } catch (e) {
                console.warn('BRV L2 (iframe) failed â†’', e);
                if (blobURL) URL.revokeObjectURL(blobURL);
                await brvLayer3Base64(fileData, fileName);
            }
        }

        /** LAYER 3 â€” Base64 data-URI inside an <object> tag */
        async function brvLayer3Base64(fileData, fileName) {
            const container = document.getElementById('brv-content');
            container.innerHTML =
                '<div class="brv-loading"><div class="brv-spinner"></div><p>Ø§Ù„Ø·Ø¨Ù‚Ø© 3: Base64 URI</p><span class="brv-layer-badge">object tag</span></div>';
            try {
                // Render <object>; if the device can't handle it the inner content shows
                container.innerHTML = `
                    <object data="${fileData}" type="application/pdf" class="brv-iframe">
                        <div class="brv-dl-screen">
                            <div style="font-size:3rem;margin-bottom:1rem;">ğŸ“„</div>
                            <h3 style="margin:0 0 .5rem 0;color:#1F2937;">Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø¹Ø±Ø¶ PDF</h3>
                            <p style="color:#6B7280;margin:0 0 1.5rem 0;">Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ</p>
                        </div>
                    </object>`;

                // After 3 s silently trigger Layer 4 as a safety net
                await new Promise(r => setTimeout(r, 3000));
                brvLayer4Download(fileData, fileName, true /* silent */);
            } catch (e) {
                console.warn('BRV L3 (base64 object) failed â†’', e);
                brvLayer4Download(fileData, fileName);
            }
        }

        /**
         * LAYER 4 â€” Hidden <a download> â†’ triggers the device's native app
         * (Samsung/Huawei Notes, Files, Adobe, etc.)
         * @param {boolean} silent - if true, don't overwrite the existing modal content
         */
        function brvLayer4Download(fileData, fileName, silent = false) {
            // Fire the download link
            const a = document.createElement('a');
            a.href     = fileData;
            a.download = fileName;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            setTimeout(() => { if (document.body.contains(a)) document.body.removeChild(a); }, 1000);

            if (!silent) {
                const container = document.getElementById('brv-content');
                if (container) {
                    container.innerHTML = `
                        <div class="brv-dl-screen">
                            <div style="font-size:4rem;margin-bottom:1rem;">ğŸ“¥</div>
                            <h3 style="margin:0 0 .5rem 0;color:#1F2937;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</h3>
                            <p style="color:#6B7280;margin:0 0 1.5rem 0;line-height:1.6;">
                                Ø³ÙŠÙÙØªØ­ Ø§Ù„Ù…Ù„Ù ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¬Ù‡Ø§Ø² ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.<br>
                                Ø¥Ø°Ø§ Ù„Ù… ÙŠÙØªØ­ØŒ Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡.
                            </p>
                            <button class="brv-btn brv-btn-dl"
                                onclick="brvLayer4Download(brvCurrentFile.data, brvCurrentFile.name)">
                                ğŸ“¥ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
                            </button>
                        </div>`;
                }
            }
        }

        // â”€â”€ Utility download helpers (kept for text-converter & other tools) â”€â”€
        function downloadFile(url, fileName) {
            const a = document.createElement('a');
            a.href = url; a.download = fileName; a.style.display = 'none';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            showNotification('ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„! ğŸ“¥');
        }

        function downloadPDFDirect(fileData, fileName) {
            const a = document.createElement('a');
            a.href = fileData; a.download = fileName;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        // â”€â”€ Subject helpers â”€â”€
        function updateSubject() {
            const idx = subjects.findIndex(s => s.id === currentSubject.id);
            if (idx !== -1) { subjects[idx] = currentSubject; saveData(); }
        }

        function backToMain() {
            document.getElementById('subjectView').classList.add('hidden');
            document.getElementById('mainView').classList.remove('hidden');
            currentSubject = null;
        }

        // â”€â”€ Exams â”€â”€
        function updateExamSubjectDropdown() {
            const dd = document.getElementById('examSubject');
            dd.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>';
            subjects.forEach(s => { const o = document.createElement('option'); o.value = s.id; o.textContent = s.name; dd.appendChild(o); });
        }

        function showAddExamForm() { document.getElementById('addExamForm').classList.remove('hidden'); }
        function hideAddExamForm() {
            document.getElementById('addExamForm').classList.add('hidden');
            document.getElementById('examSubject').value = '';
            document.getElementById('examType').value = 'mid';
            document.getElementById('examDate').value = '';
            document.getElementById('examTime').value = '';
        }

        async function addExamToSchedule() {
            const subjectId = parseInt(document.getElementById('examSubject').value);
            const type = document.getElementById('examType').value;
            const date = document.getElementById('examDate').value;
            const time = document.getElementById('examTime').value;
            if (!subjectId || !date || !time) { alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); return; }
            const subject = subjects.find(s => s.id === subjectId);
            exams.push({ id: Date.now(), subjectId, subjectName: subject.name, type, date, time, examImage: null, examImageName: null });
            await saveData(); renderExamSchedule(); hideAddExamForm();
        }

        function renderExamSchedule() {
            const tbody = document.getElementById('examTableBody');
            if (!exams.length) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#6B7280;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</td></tr>'; return; }
            tbody.innerHTML = '';
            [...exams].sort((a,b) => new Date(a.date)-new Date(b.date)).forEach(exam => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${exam.subjectName}</td><td><span class="exam-type-badge ${exam.type==='mid'?'badge-mid':'badge-final'}">${exam.type==='mid'?'Ù…ÙŠØ¯ ØªÙŠØ±Ù…':'ÙØ§ÙŠÙ†Ø§Ù„'}</span></td><td>${exam.date}</td><td>${exam.time}</td><td>${exam.examImage?`<button class="btn" style="background:#3B82F6;color:white;padding:.5rem 1rem;border-radius:.5rem;font-size:.875rem;" data-view-exam="${exam.id}">ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©</button>`:`<button class="btn" style="background:#10B981;color:white;padding:.5rem 1rem;border-radius:.5rem;font-size:.875rem;" data-upload-exam="${exam.id}">ğŸ“¤ Ø±ÙØ¹ ØµÙˆØ±Ø©</button>`}</td><td><button class="btn-danger" style="padding:.5rem 1rem;border-radius:.5rem;" data-exam-id="${exam.id}">Ø­Ø°Ù</button></td>`;
                tbody.appendChild(tr);
            });
            document.querySelectorAll('[data-exam-id]').forEach(btn => btn.addEventListener('click', function() { deleteExam(parseInt(this.dataset.examId)); }));
            document.querySelectorAll('[data-upload-exam]').forEach(btn => btn.addEventListener('click', function() { uploadExamImage(parseInt(this.dataset.uploadExam)); }));
            document.querySelectorAll('[data-view-exam]').forEach(btn => btn.addEventListener('click', function() { viewExamImage(parseInt(this.dataset.viewExam)); }));
        }

        async function deleteExam(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†ØŸ')) return;
            exams = exams.filter(e => e.id !== id);
            await saveData(); renderExamSchedule(); showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­ âœ“');
        }

        function uploadExamImage(examId) {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = 'image/*';
            input.onchange = async e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async ev => {
                    const compressed = await compressImage(ev.target.result, 700, 0.65);
                    const exam = exams.find(ex => ex.id === examId);
                    exam.examImage = compressed; exam.examImageName = file.name;
                    await saveData(); renderExamSchedule(); showNotification('ØªÙ… Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­ âœ“');
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        function viewExamImage(examId) {
            const exam = exams.find(ex => ex.id === examId);
            if (!exam || !exam.examImage) return;
            // Use BRV for exam images too
            brvCurrentFile = { data: exam.examImage, name: exam.examImageName || 'exam-image.jpg' };
            showBRVModal(brvCurrentFile.name);
            brvShowImage(exam.examImage);
        }

        async function handleScheduleImageUpload(e, type) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async ev => {
                examScheduleImages[type] = await compressImage(ev.target.result, 900, 0.7);
                await saveData(); renderScheduleImages(); showNotification('ØªÙ… Ø­ÙØ¸ ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ“');
            };
            reader.readAsDataURL(file);
        }

        function renderScheduleImages() {
            ['mid','final'].forEach(type => {
                const preview = document.getElementById(`${type}ExamSchedulePreview`);
                if (examScheduleImages[type]) {
                    preview.innerHTML = `<div style="position:relative;"><img src="${examScheduleImages[type]}" style="max-width:100%;border-radius:.5rem;cursor:pointer;" onclick="viewScheduleImage('${type}')"><button class="delete-btn" onclick="deleteScheduleImage('${type}')" style="position:absolute;top:.5rem;left:.5rem;">Ã—</button></div>`;
                } else {
                    preview.innerHTML = `ğŸ“¤ Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¬Ø¯ÙˆÙ„ ${type === 'mid' ? 'Ø§Ù„Ù…ÙŠØ¯ ØªÙŠØ±Ù…' : 'Ø§Ù„ÙØ§ÙŠÙ†Ø§Ù„'}`;
                }
            });
        }

        function viewScheduleImage(type) {
            if (!examScheduleImages[type]) return;
            brvCurrentFile = { data: examScheduleImages[type], name: `schedule-${type}.jpg` };
            showBRVModal(brvCurrentFile.name);
            brvShowImage(examScheduleImages[type]);
        }

        function deleteScheduleImage(type) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ØŸ')) return;
            examScheduleImages[type] = null;
            saveData(); renderScheduleImages(); showNotification('ØªÙ… Ø­Ø°Ù ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ“');
        }

        // â”€â”€ Online Lectures â”€â”€
        function openOnlineLectures() {
            if ('Notification' in window && Notification.permission === 'default') { showNotificationPermissionDialog(); return; }
            if ('Notification' in window && Notification.permission === 'granted') notificationPermission = true;
            renderOnlineLecturesModal();
        }

        function showNotificationPermissionDialog() {
            const dialog = document.createElement('div');
            dialog.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:20000;display:flex;align-items:center;justify-content:center;padding:1rem;';
            dialog.innerHTML = `<div style="background:white;border-radius:1rem;padding:2rem;max-width:450px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.3);"><div style="text-align:center;margin-bottom:1.5rem;"><div style="font-size:4rem;margin-bottom:1rem;">ğŸ””</div><h3 style="margin:0 0 .5rem 0;color:#1F2937;font-size:1.5rem;">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3><p style="margin:0;color:#6B7280;line-height:1.6;">Ù†ÙˆØ¯ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„ØªØ°ÙƒÙŠØ±Ùƒ Ø¨Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</p></div><div style="display:grid;gap:.75rem;"><button id="allowNotifications" style="background:linear-gradient(135deg,#10B981 0%,#059669 100%);color:white;border:none;padding:1rem;border-radius:.75rem;cursor:pointer;font-weight:600;font-size:1rem;">âœ“ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button><button id="denyNotifications" style="background:#6B7280;color:white;border:none;padding:1rem;border-radius:.75rem;cursor:pointer;font-weight:600;font-size:1rem;">Ã— Ø±ÙØ¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button></div></div>`;
            document.body.appendChild(dialog);
            document.getElementById('allowNotifications').onclick = async () => {
                const perm = await Notification.requestPermission();
                notificationPermission = perm === 'granted';
                dialog.remove();
                if (notificationPermission) showNotification('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! âœ“', 2000);
                renderOnlineLecturesModal();
            };
            document.getElementById('denyNotifications').onclick = () => { dialog.remove(); renderOnlineLecturesModal(); };
        }

        function renderOnlineLecturesModal() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.95);z-index:10000;display:flex;flex-direction:column;padding:1rem;overflow-y:auto;';
            modal.innerHTML = `<div style="background:white;border-radius:1rem;padding:2rem;max-width:1000px;margin:auto;width:100%;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;"><h2 style="margin:0;">ğŸ• Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</h2><button onclick="this.closest('[style]').parentElement.remove()" style="background:#EF4444;color:white;border:none;border-radius:.5rem;padding:.75rem 1.5rem;cursor:pointer;font-weight:600;">âœ• Ø¥ØºÙ„Ø§Ù‚</button></div>
                <div style="background:linear-gradient(135deg,#F0F9FF 0%,#E0E7FF 100%);border-radius:.75rem;padding:1.5rem;margin-bottom:1.5rem;">
                    <h3 style="margin-bottom:1rem;">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø§Ø¶Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                    <div style="display:grid;gap:1rem;">
                        <select id="lectureSubject" class="input"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>${subjects.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}</select>
                        <input type="text" id="lectureTitle" class="input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                        <input type="date" id="lectureDate" class="input">
                        <input type="time" id="lectureTime" class="input">
                        <input type="url" id="lectureLink" class="input" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© (Zoom, Teams, Ø¥Ù„Ø®)">
                        <div style="background:white;border-radius:.5rem;padding:1rem;border:2px solid #D1D5DB;">
                            <h4 style="margin:0 0 .75rem 0;font-size:.875rem;">â° Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h4>
                            <div style="display:grid;gap:.75rem;">
                                <div style="display:flex;align-items:center;gap:.5rem;"><label style="font-size:.875rem;color:#6B7280;">Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:</label><input type="number" id="notificationCount" class="input" min="1" max="10" value="3" style="width:80px;padding:.5rem;"></div>
                                <div style="display:flex;align-items:center;gap:.5rem;"><label style="font-size:.875rem;color:#6B7280;">Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† ÙƒÙ„ Ø¥Ø´Ø¹Ø§Ø± (Ø¯Ù‚Ø§Ø¦Ù‚):</label><input type="number" id="notificationInterval" class="input" min="5" max="120" value="15" style="width:80px;padding:.5rem;"></div>
                            </div>
                        </div>
                        <button onclick="addOnlineLecture()" style="background:linear-gradient(135deg,#3B82F6 0%,#6366F1 100%);color:white;border:none;padding:.75rem;border-radius:.75rem;cursor:pointer;font-weight:600;font-size:1rem;">Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</button>
                    </div>
                </div>
                <div id="lecturesList">${renderLecturesList()}</div>
            </div>`;
            document.body.appendChild(modal);
        }

        function renderLecturesList() {
            if (!onlineLectures.length) return '<p style="text-align:center;color:#6B7280;padding:2rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</p>';
            return [...onlineLectures].sort((a,b)=>new Date(a.date+' '+a.time)-new Date(b.date+' '+b.time)).map(l => {
                const subject = subjects.find(s=>s.id===l.subjectId);
                const isPast = new Date(l.date+' '+l.time) < new Date();
                return `<div style="background:${isPast?'#F3F4F6':'white'};border-radius:.75rem;padding:1.5rem;border:2px solid ${isPast?'#E5E7EB':'#BFDBFE'};margin-bottom:1rem;${isPast?'opacity:.7;':''}"><div style="display:flex;justify-content:space-between;align-items:start;"><div style="flex:1;"><h4 style="margin:0 0 .5rem 0;">${l.title||'Ù…Ø­Ø§Ø¶Ø±Ø©'}</h4><p style="margin:0;color:#6B7280;font-size:.875rem;">ğŸ“š ${subject?subject.name:'Ù…Ø§Ø¯Ø© Ù…Ø­Ø°ÙˆÙØ©'}</p><p style="margin:.25rem 0 0 0;color:#6B7280;font-size:.875rem;">ğŸ“… ${l.date} â€¢ â° ${l.time}</p>${l.link?`<a href="${l.link}" target="_blank" style="color:#3B82F6;font-size:.875rem;text-decoration:none;display:inline-block;margin-top:.5rem;">ğŸ”— ÙØªØ­ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</a>`:''}<p style="margin:.5rem 0 0 0;color:#8B5CF6;font-size:.75rem;">ğŸ”” ${l.notificationCount} Ø¥Ø´Ø¹Ø§Ø± ÙƒÙ„ ${l.notificationInterval} Ø¯Ù‚ÙŠÙ‚Ø©</p></div><button onclick="deleteOnlineLecture(${l.id})" style="background:#EF4444;color:white;border:none;border-radius:.5rem;padding:.5rem 1rem;cursor:pointer;font-size:.875rem;">ğŸ—‘ï¸</button></div></div>`;
            }).join('');
        }

        function addOnlineLecture() {
            const subjectId = parseInt(document.getElementById('lectureSubject').value);
            const title = document.getElementById('lectureTitle').value;
            const date = document.getElementById('lectureDate').value;
            const time = document.getElementById('lectureTime').value;
            const link = document.getElementById('lectureLink').value;
            const notificationCount = parseInt(document.getElementById('notificationCount').value);
            const notificationInterval = parseInt(document.getElementById('notificationInterval').value);
            if (!subjectId || !date || !time) { alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ù…Ù„Ø£ Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); return; }
            onlineLectures.push({ id: Date.now(), subjectId, title, date, time, link, notificationCount, notificationInterval, notificationsSent: [] });
            saveData();
            const ll = document.getElementById('lecturesList');
            if (ll) ll.innerHTML = renderLecturesList();
            ['lectureSubject','lectureTitle','lectureDate','lectureTime','lectureLink'].forEach(id => { document.getElementById(id).value=''; });
            document.getElementById('notificationCount').value='3';
            document.getElementById('notificationInterval').value='15';
            showNotification('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­! âœ“');
        }

        function deleteOnlineLecture(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©ØŸ')) return;
            onlineLectures = onlineLectures.filter(l=>l.id!==id);
            saveData();
            const ll = document.getElementById('lecturesList');
            if (ll) ll.innerHTML = renderLecturesList();
            showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ“');
        }

        function checkUpcomingLectures() {
            if (!notificationPermission || !onlineLectures.length) return;
            const now = new Date();
            onlineLectures.forEach(l => {
                if (!l.notificationsSent) l.notificationsSent = [];
                const ldt = new Date(l.date+' '+l.time);
                for (let i = 0; i < l.notificationCount; i++) {
                    const nt = new Date(ldt.getTime() - i*l.notificationInterval*60000);
                    const key = `${i}`;
                    if (nt-now>0 && nt-now<=60000 && !l.notificationsSent.includes(key)) {
                        const subject = subjects.find(s=>s.id===l.subjectId);
                        const n = new Notification('ØªØ°ÙƒÙŠØ±: Ù…Ø­Ø§Ø¶Ø±Ø© Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†', { body:`${l.title||'Ù…Ø­Ø§Ø¶Ø±Ø©'} - ${subject?subject.name:'Ù…Ø§Ø¯Ø©'}\nØªØ¨Ø¯Ø£ Ø¨Ø¹Ø¯ ${i*l.notificationInterval} Ø¯Ù‚ÙŠÙ‚Ø©`, tag:`lecture-${l.id}-${i}`, requireInteraction:true });
                        if (l.link) n.onclick = function() { window.open(l.link,'_blank'); this.close(); };
                        l.notificationsSent.push(key);
                        saveData();
                    }
                }
            });
        }

        // â”€â”€ Export / Import â”€â”€
        async function exportAllData() {
            const btn = document.getElementById('exportDataBtn');
            const orig = btn.innerHTML;
            btn.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±...'; btn.disabled = true;
            try {
                const blob = new Blob([JSON.stringify({ version:'1.0', exportDate:new Date().toISOString(), subjects, exams, examScheduleImages, onlineLectures }, null, 2)], {type:'application/json'});
                const url = URL.createObjectURL(blob);
                const now = new Date();
                const a = document.createElement('a');
                a.href = url; a.download = `study-organizer-backup-${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                btn.innerHTML = 'âœ“ ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±!'; btn.style.background = '#059669';
                setTimeout(() => { btn.innerHTML = orig; btn.style.background = 'linear-gradient(135deg,#10B981 0%,#059669 100%)'; btn.disabled = false; }, 2000);
                showNotification('ØªÙ… ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! ğŸ“¦', 2500);
            } catch { btn.innerHTML = orig; btn.disabled = false; alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ±.'); }
        }

        async function importAllData(e) {
            const file = e.target.files[0];
            if (!file) return;
            const btn = document.getElementById('importDataBtn');
            const orig = btn.innerHTML;
            btn.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯...'; btn.disabled = true;
            const reader = new FileReader();
            reader.onload = async ev => {
                try {
                    const data = JSON.parse(ev.target.result);
                    if (!data.version || !data.subjects) throw new Error('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­');
                    if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ\nğŸ“š Ø§Ù„Ù…ÙˆØ§Ø¯: ${data.subjects.length}\nğŸ“ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª: ${data.exams?.length||0}\nğŸ• Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª: ${data.onlineLectures?.length||0}\nâš ï¸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.`)) { btn.innerHTML = orig; btn.disabled = false; return; }
                    subjects = data.subjects||[]; exams = data.exams||[]; examScheduleImages = data.examScheduleImages||{mid:null,final:null}; onlineLectures = data.onlineLectures||[];
                    await saveData(); renderSubjects(); updateExamSubjectDropdown();
                    btn.innerHTML = 'âœ“ ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯!'; btn.style.background = '#059669';
                    setTimeout(() => { btn.innerHTML = orig; btn.style.background = 'linear-gradient(135deg,#3B82F6 0%,#6366F1 100%)'; btn.disabled = false; }, 2000);
                    showNotification('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! ğŸ“¥', 2500);
                } catch { alert('Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø± ØºÙŠØ± ØµØ§Ù„Ø­.'); btn.innerHTML = orig; btn.disabled = false; }
                document.getElementById('importFileInput').value = '';
            };
            reader.readAsText(file);
        }

        // â”€â”€ Search â”€â”€
        function handleSearch(e) {
            const term = e.target.value.toLowerCase().trim();
            const rc = document.getElementById('searchResultsContent');
            if (!term) { rc.innerHTML = '<h3 style="margin-bottom:1rem;color:#6B7280;">Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…ÙÙŠØ¯Ø© Ù„Ù„Ø¨Ø­Ø«:</h3>'; return; }
            const results = [];
            subjects.forEach(s => {
                if (s.name.toLowerCase().includes(term)||s.doctor.toLowerCase().includes(term)) results.push({type:'subject',title:s.name,desc:`Ø¯. ${s.doctor}`,action:()=>{switchTab('subjects');setTimeout(()=>showSubjectDetail(s.id),100);}});
                s.weeks.forEach(w => {
                    [{key:'lectureSummaryName',label:'Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©'},{key:'sectionSummaryName',label:'Ù…Ù„Ø®Øµ Ø§Ù„Ø³ÙƒØ´Ù†'},{key:'questionsName',label:'Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©'}].forEach(f => {
                        if (w[f.key]&&w[f.key].toLowerCase().includes(term)) results.push({type:'file',title:w[f.key],desc:`${s.name} - Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${w.number} - ${f.label}`,action:()=>{switchTab('subjects');setTimeout(()=>showSubjectDetail(s.id),100);}});
                    });
                });
                if (s.doctorQuestionsName&&s.doctorQuestionsName.toLowerCase().includes(term)) results.push({type:'file',title:s.doctorQuestionsName,desc:`${s.name} - Ù…Ù„Ù Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¯ÙƒØªÙˆØ±`,action:()=>{switchTab('subjects');setTimeout(()=>showSubjectDetail(s.id),100);}});
            });
            exams.forEach(ex => { if (ex.subjectName.toLowerCase().includes(term)||(ex.type==='mid'&&'Ù…ÙŠØ¯ ØªÙŠØ±Ù…'.includes(term))||(ex.type==='final'&&'ÙØ§ÙŠÙ†Ø§Ù„'.includes(term))) results.push({type:'exam',title:`Ø§Ù…ØªØ­Ø§Ù† ${ex.type==='mid'?'Ù…ÙŠØ¯ ØªÙŠØ±Ù…':'ÙØ§ÙŠÙ†Ø§Ù„'}`,desc:`${ex.subjectName} - ${ex.date} ${ex.time}`,action:()=>switchTab('exams')}); });
            if (!results.length) { rc.innerHTML = `<div style="text-align:center;padding:3rem;background:linear-gradient(135deg,#F3F4F6 0%,#E5E7EB 100%);border-radius:1rem;border:2px dashed #D1D5DB;"><div style="font-size:4rem;margin-bottom:1rem;">ğŸ”</div><h3 style="color:#6B7280;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</h3><p style="color:#9CA3AF;">Ø¬Ø±Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø¨ÙƒÙ„Ù…Ø§Øª Ø£Ø®Ø±Ù‰</p></div>`; return; }
            rc.innerHTML = `<h3 style="margin-bottom:1rem;color:#1F2937;">ğŸ” Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« (${results.length})</h3><div id="srGrid" style="display:grid;gap:1rem;"></div>`;
            const grid = document.getElementById('srGrid');
            results.forEach(r => {
                const card = document.createElement('div');
                card.className = 'research-card';
                card.style.cssText = 'cursor:pointer;transition:all .3s;border:2px solid #BFDBFE;';
                card.innerHTML = `<div style="display:flex;align-items:center;gap:1rem;"><div style="font-size:2rem;">${r.type==='subject'?'ğŸ“š':r.type==='file'?'ğŸ“„':'ğŸ“'}</div><div style="flex:1;"><h4 style="margin:0 0 .25rem 0;color:#1F2937;font-size:1rem;">${r.title}</h4><p style="margin:0;color:#6B7280;font-size:.875rem;">${r.desc}</p></div><div style="color:#3B82F6;font-size:1.5rem;">â†’</div></div>`;
                card.addEventListener('click', r.action);
                grid.appendChild(card);
            });
        }

        // â”€â”€ Text Converter Tool â”€â”€
        function openTextConverter() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.95);z-index:10000;display:flex;flex-direction:column;padding:1rem;overflow-y:auto;';
            modal.innerHTML = `<div style="background:white;border-radius:1rem;padding:2rem;max-width:1200px;margin:auto;width:100%;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;"><h2 style="margin:0;">âœï¸ Ù…Ø­ÙˆÙ„ Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø©</h2><button onclick="this.closest('[style*=fixed]').remove()" style="background:#EF4444;color:white;border:none;border-radius:.5rem;padding:.75rem 1.5rem;cursor:pointer;font-weight:600;">âœ• Ø¥ØºÙ„Ø§Ù‚</button></div>
                <div style="margin-bottom:1.5rem;"><label style="display:block;margin-bottom:.5rem;font-weight:600;">ğŸ“‹ Ø§Ù„ØµÙ‚ Ø§Ù„Ù†Øµ Ù‡Ù†Ø§:</label><textarea id="textInput" style="width:100%;min-height:150px;padding:1rem;border:2px solid #D1D5DB;border-radius:.75rem;font-family:inherit;font-size:1rem;resize:vertical;" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„Ù†Øµ Ù‡Ù†Ø§..."></textarea></div>
                <div style="margin-bottom:1.5rem;"><label style="display:block;margin-bottom:.5rem;font-weight:600;">ğŸ¨ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ø±ÙŠØ±:</label><div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1rem;">
                    <button onclick="formatText('bold')" style="background:#3B82F6;color:white;border:none;padding:.5rem 1rem;border-radius:.5rem;cursor:pointer;font-weight:600;">B</button>
                    <button onclick="formatText('italic')" style="background:#3B82F6;color:white;border:none;padding:.5rem 1rem;border-radius:.5rem;cursor:pointer;font-style:italic;">I</button>
                    <button onclick="formatText('underline')" style="background:#3B82F6;color:white;border:none;padding:.5rem 1rem;border-radius:.5rem;cursor:pointer;text-decoration:underline;">U</button>
                    <button onclick="highlightText('yellow')" style="background:#FEF08A;border:none;padding:.5rem 1rem;border-radius:.5rem;cursor:pointer;font-weight:600;">ğŸŸ¨ Ø£ØµÙØ±</button>
                    <button onclick="highlightText('green')" style="background:#BBF7D0;border:none;padding:.5rem 1rem;border-radius:.5rem;cursor:pointer;font-weight:600;">ğŸŸ© Ø£Ø®Ø¶Ø±</button>
                    <button onclick="highlightText('blue')" style="background:#BFDBFE;border:none;padding:.5rem 1rem;border-radius:.5rem;cursor:pointer;font-weight:600;">ğŸŸ¦ Ø£Ø²Ø±Ù‚</button>
                    <button onclick="highlightText('pink')" style="background:#FBCFE8;border:none;padding:.5rem 1rem;border-radius:.5rem;cursor:pointer;font-weight:600;">ğŸŸª ÙˆØ±Ø¯ÙŠ</button>
                    <button onclick="increaseFontSize()" style="background:#6B7280;color:white;border:none;padding:.5rem 1rem;border-radius:.5rem;cursor:pointer;font-weight:600;">A+</button>
                    <button onclick="decreaseFontSize()" style="background:#6B7280;color:white;border:none;padding:.5rem 1rem;border-radius:.5rem;cursor:pointer;font-weight:600;">A-</button>
                </div></div>
                <div style="margin-bottom:1.5rem;"><label style="display:block;margin-bottom:.5rem;font-weight:600;">ğŸ“ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø­Ø±Ø±:</label><div id="editableContent" contenteditable="true" style="width:100%;min-height:300px;padding:1.5rem;border:2px solid #D1D5DB;border-radius:.75rem;background:white;font-size:16px;line-height:1.8;overflow-y:auto;max-height:500px;column-count:2;column-gap:2rem;text-align:left;direction:ltr;"></div></div>
                <div style="display:flex;gap:.5rem;flex-wrap:wrap;">
                    <button onclick="convertText()" style="background:linear-gradient(135deg,#10B981 0%,#059669 100%);color:white;border:none;padding:.75rem 1.5rem;border-radius:.75rem;cursor:pointer;font-weight:600;font-size:1rem;">âœ“ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ</button>
                    <button onclick="clearAll()" style="background:#F59E0B;color:white;border:none;padding:.75rem 1.5rem;border-radius:.75rem;cursor:pointer;font-weight:600;font-size:1rem;">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
                    <button onclick="copyContent()" style="background:#8B5CF6;color:white;border:none;padding:.75rem 1.5rem;border-radius:.75rem;cursor:pointer;font-weight:600;font-size:1rem;">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ù†Øµ</button>
                    <button onclick="downloadAsPDF()" style="background:#EC4899;color:white;border:none;padding:.75rem 1.5rem;border-radius:.75rem;cursor:pointer;font-weight:600;font-size:1rem;">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ PDF</button>
                </div>
            </div>`;
            document.body.appendChild(modal);
            document.getElementById('textInput').addEventListener('input', convertText);
        }

        function formatText(cmd) { document.execCommand(cmd, false, null); document.getElementById('editableContent').focus(); }
        function highlightText(color) {
            const sel = window.getSelection();
            if (!sel.rangeCount) return;
            const range = sel.getRangeAt(0);
            const span = document.createElement('span');
            span.className = `highlight-${color}`; span.style.cssText = 'padding:2px 4px;border-radius:3px;';
            try { range.surroundContents(span); } catch { const c=range.extractContents(); span.appendChild(c); range.insertNode(span); }
            document.getElementById('editableContent').focus();
        }
        function increaseFontSize() { const c=document.getElementById('editableContent'); c.style.fontSize=(parseInt(window.getComputedStyle(c).fontSize)+2)+'px'; }
        function decreaseFontSize() { const c=document.getElementById('editableContent'); const sz=parseInt(window.getComputedStyle(c).fontSize); if(sz>12) c.style.fontSize=(sz-2)+'px'; }
        function clearAll() { if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ØŸ')) return; document.getElementById('textInput').value=''; document.getElementById('editableContent').innerHTML=''; }
        function convertText() { const inp=document.getElementById('textInput'); const out=document.getElementById('editableContent'); if(inp&&out&&!out.innerHTML) out.innerHTML=inp.value.replace(/\n/g,'<br>'); }
        function copyContent() { const c=document.getElementById('editableContent'); const r=document.createRange(); r.selectNodeContents(c); const s=window.getSelection(); s.removeAllRanges(); s.addRange(r); try{document.execCommand('copy');alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ø¨Ù†Ø¬Ø§Ø­! âœ“');}catch{alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø³Ø®');} s.removeAllRanges(); }
        function downloadAsPDF() {
            const c=document.getElementById('editableContent');
            const pw=window.open('','','width=800,height=600');
            pw.document.write(`<!DOCTYPE html><html dir="ltr"><head><meta charset="UTF-8"><title>Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø­Ø±Ø±</title><style>body{font-family:'Segoe UI',sans-serif;padding:2cm;line-height:1.8;font-size:14pt;direction:ltr;}.highlight-yellow{background:#FEF08A;padding:2px 4px;border-radius:3px;}.highlight-green{background:#BBF7D0;padding:2px 4px;border-radius:3px;}.highlight-blue{background:#BFDBFE;padding:2px 4px;border-radius:3px;}.highlight-pink{background:#FBCFE8;padding:2px 4px;border-radius:3px;}</style></head><body>${c.innerHTML}</body></html>`);
            pw.document.close(); pw.focus(); setTimeout(()=>{pw.print(); pw.close();},250);
        }

        // Re-attach delegated listeners for dynamically rendered research links
        document.addEventListener('click', e => {
            if (e.target && e.target.id === 'openTextConverterBtn2') { e.preventDefault(); openTextConverter(); }
            if (e.target && e.target.id === 'openOnlineLecturesBtn2') { e.preventDefault(); openOnlineLectures(); }
        });
    </script>
</body>
</html>
