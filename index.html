<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#3B82F6">
<meta name="description" content="Be Regular â€” Ù†Ø¸Ù… Ù…ÙˆØ§Ø¯Ùƒ ÙˆÙ…Ø­Ø§Ø¶Ø±Ø§ØªÙƒ Ø¨Ø³Ù‡ÙˆÙ„Ø©">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon.png">
<title>Be Regular</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#E0F2FE 0%,#DDD6FE 100%);min-height:100vh;padding:1rem}
.container{max-width:1200px;margin:0 auto}
.header{background:#fff;border-radius:1rem;box-shadow:0 10px 25px rgba(0,0,0,.1);padding:2rem;margin-bottom:1.5rem;text-align:center}
.header h1{font-size:2rem;color:#1F2937;margin-bottom:.5rem}
.header p{color:#6B7280}
.nav-tabs{display:flex;gap:1rem;margin-bottom:1.5rem;overflow-x:auto;padding:.5rem}
.nav-tab{background:#fff;border-radius:.75rem;padding:1rem 1.5rem;cursor:pointer;transition:all .3s;box-shadow:0 4px 15px rgba(0,0,0,.1);white-space:nowrap;display:flex;align-items:center;gap:.5rem;font-weight:600;border:none;font-size:1rem}
.nav-tab:hover{box-shadow:0 8px 25px rgba(0,0,0,.15);transform:translateY(-2px)}
.nav-tab.active{background:linear-gradient(135deg,#3B82F6 0%,#6366F1 100%);color:#fff}
.card{background:#fff;border-radius:1rem;box-shadow:0 10px 25px rgba(0,0,0,.1);padding:1.5rem;margin-bottom:1.5rem}
.subjects-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1rem}
.subject-card{background:#fff;border-radius:1rem;box-shadow:0 4px 15px rgba(0,0,0,.1);padding:1.5rem;border:2px solid transparent;transition:all .3s;cursor:pointer}
.subject-card:hover{border-color:#3B82F6;box-shadow:0 8px 25px rgba(0,0,0,.15)}
.subject-header{display:flex;align-items:center;gap:1rem;margin-bottom:1rem}
.subject-image{width:64px;height:64px;border-radius:50%;object-fit:cover;border:2px solid #BFDBFE}
.subject-info h3{font-size:1.125rem;color:#1F2937;margin-bottom:.25rem}
.subject-info p{font-size:.875rem;color:#6B7280}
.add-subject-btn{background:linear-gradient(135deg,#60A5FA 0%,#6366F1 100%);color:#fff;border:2px dashed #93C5FD;border-radius:1rem;padding:3rem;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:1rem;transition:all .3s;min-height:160px}
.add-subject-btn:hover{box-shadow:0 8px 25px rgba(0,0,0,.15);transform:translateY(-2px)}
.btn{padding:.75rem 1.5rem;border:none;border-radius:.75rem;cursor:pointer;font-size:1rem;font-weight:600;transition:all .3s}
.btn-primary{background:linear-gradient(135deg,#3B82F6 0%,#6366F1 100%);color:#fff}
.btn-primary:hover{box-shadow:0 4px 15px rgba(59,130,246,.4)}
.btn-danger{background:#EF4444;color:#fff}
.btn-danger:hover{background:#DC2626}
.input{width:100%;padding:.75rem;border:2px solid #D1D5DB;border-radius:.75rem;font-size:1rem;transition:border-color .3s;font-family:inherit}
.input:focus{outline:none;border-color:#3B82F6}
.textarea{width:100%;padding:.75rem;border:2px solid #D1D5DB;border-radius:.75rem;font-size:1rem;min-height:120px;resize:vertical;font-family:inherit}
.textarea:focus{outline:none;border-color:#3B82F6}
.upload-area{border:2px dashed #D1D5DB;border-radius:.75rem;padding:2rem;text-align:center;cursor:pointer;transition:border-color .3s}
.upload-area:hover{border-color:#3B82F6}
.delete-btn{background:#EF4444;color:#fff;border:none;border-radius:50%;width:32px;height:32px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.1rem;line-height:1;flex-shrink:0}
.delete-btn:hover{background:#DC2626}
.week-card{background:linear-gradient(135deg,#ECFDF5 0%,#DBEAFE 100%);border-radius:.75rem;padding:1rem;margin-bottom:1rem;border:1px solid #D1FAE5}
.week-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
.week-files{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:.75rem}
.file-slot{border:2px dashed #D1D5DB;border-radius:.5rem;padding:.75rem;text-align:center;cursor:pointer;font-size:.75rem;min-height:80px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.25rem;transition:border-color .3s;position:relative}
.file-slot:hover{border-color:#3B82F6}
.file-slot.has-file{border-style:solid;border-color:#10B981;background:#F0FDF4}
.file-name{font-size:.7rem;color:#059669;word-break:break-all;max-width:100%}
.file-open-btn{background:#10B981;color:#fff;border:none;padding:.25rem .6rem;border-radius:.25rem;font-size:.7rem;cursor:pointer;margin-top:.25rem}
.file-open-btn:hover{background:#059669}
.add-more-btn{position:absolute;top:-8px;left:-8px;color:#fff;border:none;border-radius:.4rem;padding:.25rem .5rem;font-size:.7rem;cursor:pointer;font-weight:700;z-index:5;box-shadow:0 2px 6px rgba(0,0,0,.2)}
/* ØµÙˆØ± Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ */
.images-scroll{display:flex;gap:.5rem;overflow-x:auto;padding:.5rem 0;-webkit-overflow-scrolling:touch;scrollbar-width:thin}
.images-scroll::-webkit-scrollbar{height:4px}
.images-scroll::-webkit-scrollbar-thumb{background:#CBD5E1;border-radius:2px}
.img-thumb{position:relative;flex-shrink:0;width:110px;height:80px;border-radius:.5rem;overflow:hidden;border:2px solid #E5E7EB;cursor:pointer}
.img-thumb img{width:100%;height:100%;object-fit:cover;transition:transform .2s}
.img-thumb:hover img{transform:scale(1.05)}
.img-thumb .del-img{position:absolute;top:2px;left:2px;background:rgba(239,68,68,.85);color:#fff;border:none;border-radius:50%;width:22px;height:22px;font-size:.8rem;cursor:pointer;display:flex;align-items:center;justify-content:center;line-height:1}
.img-add{flex-shrink:0;width:80px;height:80px;border-radius:.5rem;border:2px dashed #93C5FD;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;font-size:.65rem;color:#3B82F6;gap:.25rem;transition:all .2s}
.img-add:hover{border-color:#6366F1;background:#EEF2FF}
.hidden{display:none!important}
.back-btn{color:#3B82F6;cursor:pointer;font-size:1rem;margin-bottom:1rem;display:inline-block;background:none;border:none}
.back-btn:hover{color:#2563EB}
.exam-table{width:100%;border-collapse:collapse;margin-top:1rem}
.exam-table th,.exam-table td{padding:1rem;text-align:right;border-bottom:1px solid #E5E7EB}
.exam-table th{background:linear-gradient(135deg,#3B82F6 0%,#6366F1 100%);color:#fff;font-weight:600}
.exam-table tr:hover td{background:#F9FAFB}
.badge{display:inline-block;padding:.25rem .75rem;border-radius:.5rem;font-size:.875rem;font-weight:600}
.badge-mid{background:#FEF3C7;color:#92400E}
.badge-final{background:#DBEAFE;color:#1E40AF}
.search-input{width:100%;padding:1rem;border:2px solid #D1D5DB;border-radius:.75rem;font-size:1.125rem;transition:all .3s;margin-bottom:1.5rem;font-family:inherit}
.search-input:focus{outline:none;border-color:#3B82F6;box-shadow:0 0 0 3px rgba(59,130,246,.1)}
.res-card{background:linear-gradient(135deg,#F0F9FF 0%,#FEF3C7 100%);border-radius:1rem;padding:1.5rem;margin-bottom:1rem;border:2px solid #BFDBFE}
.res-card h3{color:#1F2937;margin-bottom:.5rem}
.res-card p{color:#6B7280;margin-bottom:1rem}
.res-links{display:flex;gap:.5rem;flex-wrap:wrap}
.res-link{background:#fff;color:#3B82F6;padding:.5rem 1rem;border-radius:.5rem;text-decoration:none;font-weight:600;border:2px solid #3B82F6;transition:all .3s;cursor:pointer}
.res-link:hover{background:#3B82F6;color:#fff}
.salawat-btn{color:#10B981;font-size:.875rem;cursor:pointer;user-select:none;transition:all .2s}
.salawat-btn:hover{color:#059669;transform:scale(1.05)}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Be Regular</h1>
    <p>Ù†Ø¸Ù… Ù…ÙˆØ§Ø¯Ùƒ ÙˆÙ…Ø­Ø§Ø¶Ø±Ø§ØªÙƒ Ø¨Ø³Ù‡ÙˆÙ„Ø©</p>
  </div>

  <!-- Navigation -->
  <div class="nav-tabs">
    <button class="nav-tab active" id="tab-subjects">ğŸ“š Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</button>
    <button class="nav-tab" id="tab-exams">ğŸ“ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</button>
    <button class="nav-tab" id="tab-research">ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø£Ø¯ÙˆØ§Øª</button>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SUBJECTS TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="subjectsTab">
    <!-- Main grid -->
    <div id="mainView">
      <div class="subjects-grid" id="subjectsGrid">
        <button class="add-subject-btn" id="addSubjectBtn">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          <span style="font-size:1.125rem">Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
        </button>
      </div>
    </div>

    <!-- Add subject form -->
    <div id="addSubjectForm" class="card hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
        <h2>Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
        <button id="closeSubjectForm" style="border:none;background:none;cursor:pointer;font-size:1.5rem">Ã—</button>
      </div>
      <div style="display:flex;flex-direction:column;gap:1rem">
        <input type="text" id="subjectName" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©">
        <input type="text" id="doctorName" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙƒØªÙˆØ±/Ø§Ù„Ø¯ÙƒØªÙˆØ±Ø©">
        <div class="upload-area" id="uploadImageArea">
          <div id="subjectImagePreview"></div>
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#9CA3AF" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          <p style="color:#6B7280;margin-top:.5rem">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø§Ø¯Ø©</p>
          <input type="file" id="subjectImageInput" accept="image/*" class="hidden">
        </div>
        <button class="btn btn-primary" id="saveSubjectBtn">Ø­ÙØ¸ Ø§Ù„Ù…Ø§Ø¯Ø©</button>
      </div>
    </div>

    <!-- Subject detail -->
    <div id="subjectView" class="card hidden"></div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• EXAMS TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="examsTab" class="hidden">
    <div class="card">
      <h2 style="margin-bottom:1.5rem">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</h2>

      <!-- Schedule images -->
      <div style="margin-bottom:2rem;padding:1.5rem;background:linear-gradient(135deg,#FEF3C7 0%,#DBEAFE 100%);border-radius:.75rem;border:2px solid #FDE68A">
        <h3 style="margin-bottom:1rem;color:#1F2937">ğŸ“¸ ØµÙˆØ± Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1rem">
          <div>
            <h4 style="font-size:.875rem;margin-bottom:.5rem;color:#6B7280">ØµÙˆØ±Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙŠØ¯ ØªÙŠØ±Ù…</h4>
            <div class="upload-area" id="midExamArea" style="min-height:120px">
              <div id="midExamPreview">ğŸ“¤ Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙŠØ¯ ØªÙŠØ±Ù…</div>
              <input type="file" id="midExamInput" accept="image/*" class="hidden">
            </div>
          </div>
          <div>
            <h4 style="font-size:.875rem;margin-bottom:.5rem;color:#6B7280">ØµÙˆØ±Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ§ÙŠÙ†Ø§Ù„</h4>
            <div class="upload-area" id="finalExamArea" style="min-height:120px">
              <div id="finalExamPreview">ğŸ“¤ Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ§ÙŠÙ†Ø§Ù„</div>
              <input type="file" id="finalExamInput" accept="image/*" class="hidden">
            </div>
          </div>
        </div>
      </div>

      <!-- Manual exams -->
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
        <h3>Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠØ§Ù‹</h3>
        <button class="btn" style="background:linear-gradient(135deg,#10B981 0%,#059669 100%);color:#fff" id="addExamBtn">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù…ØªØ­Ø§Ù†</button>
      </div>

      <div id="addExamForm" class="hidden" style="margin-bottom:2rem;padding:1.5rem;background:#F9FAFB;border-radius:.75rem">
        <h3 style="margin-bottom:1rem">Ø¥Ø¶Ø§ÙØ© Ø§Ù…ØªØ­Ø§Ù† Ø¬Ø¯ÙŠØ¯</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1rem">
          <select id="examSubject" class="input"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option></select>
          <select id="examType" class="input"><option value="mid">Ù…ÙŠØ¯ ØªÙŠØ±Ù…</option><option value="final">ÙØ§ÙŠÙ†Ø§Ù„</option></select>
          <input type="date" id="examDate" class="input">
          <input type="time" id="examTime" class="input">
        </div>
        <div style="display:flex;gap:.5rem">
          <button class="btn btn-primary" id="saveExamBtn">Ø­ÙØ¸</button>
          <button class="btn" style="background:#6B7280;color:#fff" id="cancelExamBtn">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>

      <table class="exam-table">
        <thead>
          <tr><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>ØµÙˆØ±Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
        </thead>
        <tbody id="examTableBody">
          <tr><td colspan="6" style="text-align:center;color:#6B7280">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESEARCH TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="researchTab" class="hidden">
    <div class="card">
      <h2 style="margin-bottom:1.5rem">Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø£Ø¯ÙˆØ§Øª</h2>

      <!-- Backup -->
      <div style="background:linear-gradient(135deg,#FEF3C7 0%,#FED7AA 100%);border-radius:1rem;padding:1.5rem;margin-bottom:2rem;border:2px solid #FDE68A">
        <h3 style="margin-bottom:.75rem;color:#92400E">ğŸ’¾ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
        <p style="color:#78350F;margin-bottom:1rem;line-height:1.6">Ø§Ø­Ù…Ù Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ù† Ø§Ù„Ø¶ÙŠØ§Ø¹! ØµØ¯Ù‘Ø± Ø¬Ù…ÙŠØ¹ Ù…ÙˆØ§Ø¯Ùƒ ÙÙŠ Ù…Ù„Ù ÙˆØ§Ø­Ø¯ ÙˆØ§Ø³ØªØ¹Ø¯Ù‡Ø§ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª.</p>
        <div style="display:flex;gap:.75rem;flex-wrap:wrap">
          <button id="exportBtn" class="btn" style="background:linear-gradient(135deg,#10B981 0%,#059669 100%);color:#fff">ğŸ“¦ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
          <button id="importBtn" class="btn" style="background:linear-gradient(135deg,#3B82F6 0%,#6366F1 100%);color:#fff">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
          <input type="file" id="importFileInput" accept=".json" class="hidden">
        </div>
      </div>

      <input type="text" id="searchInput" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø§Ø¯Ø© Ø£Ùˆ Ù…Ù„Ù...">
      <div id="searchResultsContent"></div>

      <div id="staticResources">
        <div class="res-card">
          <h3>ğŸ““ Notebook LM</h3><p>Ø£Ø¯Ø§Ø© Google Ø§Ù„Ø°ÙƒÙŠØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø©</p>
          <div class="res-links"><a href="https://notebooklm.google.com" target="_blank" class="res-link">Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹</a></div>
        </div>
        <div class="res-card">
          <h3>ğŸŒ´ Jungle AI</h3><p>Ø¨Ø·Ø§Ù‚Ø§Øª ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø°ÙƒÙŠØ© Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
          <div class="res-links"><a href="https://jungleai.com" target="_blank" class="res-link">Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹</a></div>
        </div>
        <div class="res-card">
          <h3>âœï¸ Ù…Ø­ÙˆÙ„ Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø©</h3><p>ØªØ­Ø±ÙŠØ± Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„ØªØ¸Ù„ÙŠÙ„ ÙˆØªØ­Ù…ÙŠÙ„ PDF</p>
          <div class="res-links"><button class="res-link" id="openTextConverter">ÙØªØ­ Ø§Ù„Ø£Ø¯Ø§Ø©</button></div>
        </div>
        <div class="res-card">
          <h3>ğŸ–¼ï¸ Ù…Ø­ÙˆÙ„ Ø§Ù„ØµÙˆØ± Ø¥Ù„Ù‰ PDF</h3><p>Ø­ÙˆÙ‘Ù„ Ø§Ù„ØµÙˆØ± Ø¥Ù„Ù‰ PDF Ø¨Ø³Ù‡ÙˆÙ„Ø©</p>
          <div class="res-links"><a href="https://www.ilovepdf.com/jpg_to_pdf" target="_blank" class="res-link">ÙØªØ­ Ø§Ù„Ø£Ø¯Ø§Ø©</a></div>
        </div>
        <div class="res-card" style="background:linear-gradient(135deg,#DBEAFE 0%,#E0E7FF 100%)">
          <h3>ğŸ• Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</h3><p>Ø­Ø¯Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù…Ø­Ø§Ø¶Ø±Ø§ØªÙƒ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</p>
          <div class="res-links"><button class="res-link" id="openOnlineLectures">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</button></div>
        </div>
        <div class="res-card">
          <h3>ğŸ“– Google Scholar</h3><p>Ù…Ø­Ø±Ùƒ Ø¨Ø­Ø« Ù„Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ø¹Ù„Ù…ÙŠØ©</p>
          <div class="res-links"><a href="https://scholar.google.com" target="_blank" class="res-link">Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹</a></div>
        </div>
        <div class="res-card">
          <h3>ğŸ“ Wikipedia</h3><p>Ù…ÙˆØ³ÙˆØ¹Ø© Ø­Ø±Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</p>
          <div class="res-links">
            <a href="https://ar.wikipedia.org" target="_blank" class="res-link">Ø¹Ø±Ø¨ÙŠ</a>
            <a href="https://en.wikipedia.org" target="_blank" class="res-link">English</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div><!-- /container -->

<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let subjects = [], exams = [], scheduleImages = {mid:null,final:null},
    onlineLectures = [], currentSubject = null, db;

const DB_NAME = 'BeRegularDB', DB_VERSION = 3;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SERVICE WORKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(r => console.log('[SW] registered', r.scope))
      .catch(e => console.warn('[SW] registration failed', e));
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INDEXED DB  (version 3)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initDB() {
  return new Promise((res, rej) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onerror = () => rej(req.error);
    req.onsuccess = () => { db = req.result; res(db); };
    req.onupgradeneeded = e => {
      const d = e.target.result;
      ['subjects','exams','settings','lectures'].forEach(name => {
        if (!d.objectStoreNames.contains(name)) {
          if (name === 'settings') d.createObjectStore(name);
          else d.createObjectStore(name, {keyPath:'id'});
        }
      });
    };
  });
}

function dbPut(store, data, key) {
  return new Promise((res, rej) => {
    const tx = db.transaction([store], 'readwrite');
    const st = tx.objectStore(store);
    if (Array.isArray(data)) { st.clear(); data.forEach(i => st.put(i)); }
    else st.put(data, key || 'default');
    tx.oncomplete = res; tx.onerror = () => rej(tx.error);
  });
}

function dbGetAll(store) {
  return new Promise((res, rej) => {
    const tx = db.transaction([store], 'readonly');
    const req = tx.objectStore(store).getAll();
    req.onsuccess = () => res(req.result || []);
    req.onerror = () => rej(req.error);
  });
}

function dbGet(store, key) {
  return new Promise((res, rej) => {
    const tx = db.transaction([store], 'readonly');
    const req = tx.objectStore(store).get(key || 'default');
    req.onsuccess = () => res(req.result || null);
    req.onerror = () => rej(req.error);
  });
}

async function saveAll() {
  try {
    await dbPut('subjects', subjects);
    await dbPut('exams', exams);
    await dbPut('settings', scheduleImages, 'scheduleImages');
    await dbPut('lectures', onlineLectures);
  } catch(e) { console.error('saveAll error', e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('load', async () => {
  try {
    await initDB();
    subjects        = await dbGetAll('subjects');
    exams           = await dbGetAll('exams');
    const si        = await dbGet('settings', 'scheduleImages');
    if (si) scheduleImages = si;
    onlineLectures  = await dbGetAll('lectures');
  } catch(e) {
    console.warn('IndexedDB load error, using localStorage fallback', e);
    try {
      subjects       = JSON.parse(localStorage.getItem('br_subjects')||'[]');
      exams          = JSON.parse(localStorage.getItem('br_exams')||'[]');
      scheduleImages = JSON.parse(localStorage.getItem('br_sched')||'{"mid":null,"final":null}');
      onlineLectures = JSON.parse(localStorage.getItem('br_lectures')||'[]');
    } catch(_){}
  }
  renderSubjects();
  updateExamDropdown();
  bindGlobalEvents();
  checkUpcomingLectures();
  setInterval(checkUpcomingLectures, 60000);
});

window.addEventListener('beforeunload', saveAll);
setInterval(saveAll, 180000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function compressImage(b64, maxW=800, q=0.65) {
  return new Promise(res => {
    const img = new Image();
    img.onload = () => {
      const c = document.createElement('canvas');
      let w = img.width, h = img.height;
      if (w > maxW) { h = h*maxW/w; w = maxW; }
      c.width = w; c.height = h;
      c.getContext('2d').drawImage(img,0,0,w,h);
      res(c.toDataURL('image/jpeg', q));
    };
    img.src = b64;
  });
}

function showToast(msg, dur=2000) {
  const old = document.getElementById('_toast');
  if (old) old.remove();
  const t = document.createElement('div');
  t.id = '_toast';
  t.textContent = msg;
  t.style.cssText = 'position:fixed;top:1.5rem;right:1.5rem;background:linear-gradient(135deg,#10B981,#059669);color:#fff;padding:.875rem 1.5rem;border-radius:.75rem;box-shadow:0 10px 25px rgba(0,0,0,.2);z-index:99999;font-weight:600;animation:slideIn .3s ease-out';
  document.body.appendChild(t);
  setTimeout(() => {
    t.style.animation = 'slideOut .3s ease-out';
    setTimeout(() => t.remove(), 300);
  }, dur);
}

function openBlobURL(b64, name) {
  try {
    const mime = b64.split(',')[0].split(':')[1].split(';')[0];
    const bin  = atob(b64.split(',')[1]);
    const u8   = new Uint8Array(bin.length);
    for (let i=0; i<bin.length; i++) u8[i] = bin.charCodeAt(i);
    const url  = URL.createObjectURL(new Blob([u8], {type: mime}));
    const w    = window.open(url, '_blank');
    if (!w) { showDownloadFallback(b64, name); }
    setTimeout(() => URL.revokeObjectURL(url), 60000);
  } catch(e) { showDownloadFallback(b64, name); }
}

function showDownloadFallback(b64, name) {
  const m = document.createElement('div');
  m.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:99998;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1rem;padding:2rem';
  m.innerHTML = `<div style="font-size:4rem">ğŸ“„</div>
    <p style="color:#fff;font-size:1.125rem">${name}</p>
    <button id="_dlbtn" class="btn btn-primary">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</button>
    <button id="_clbtn" class="btn" style="background:#6B7280;color:#fff">Ø¥ØºÙ„Ø§Ù‚</button>`;
  document.body.appendChild(m);
  m.querySelector('#_dlbtn').onclick = () => {
    const a = Object.assign(document.createElement('a'), {href:b64, download:name});
    document.body.appendChild(a); a.click(); a.remove();
  };
  m.querySelector('#_clbtn').onclick = () => m.remove();
}

function viewImageFull(src) {
  const m = document.createElement('div');
  m.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:99998;display:flex;align-items:center;justify-content:center;padding:1rem;cursor:zoom-out';
  m.innerHTML = `<img src="${src}" style="max-width:100%;max-height:95vh;border-radius:.75rem;box-shadow:0 20px 60px rgba(0,0,0,.5)">`;
  m.onclick = () => m.remove();
  document.body.appendChild(m);
}

function openBlobImage(b64) {
  try {
    const mime = b64.split(',')[0].split(':')[1].split(';')[0];
    const bin  = atob(b64.split(',')[1]);
    const u8   = new Uint8Array(bin.length);
    for (let i=0; i<bin.length; i++) u8[i] = bin.charCodeAt(i);
    const url  = URL.createObjectURL(new Blob([u8], {type: mime}));
    const w    = window.open(url, '_blank');
    if (!w) viewImageFull(b64);
    setTimeout(() => URL.revokeObjectURL(url), 30000);
  } catch(e) { viewImageFull(b64); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TAB SWITCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(name) {
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  ['subjects','exams','research'].forEach(n => {
    document.getElementById(n+'Tab').classList.toggle('hidden', n !== name);
  });
  if (name === 'exams') { renderExamSchedule(); renderScheduleImages(); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GLOBAL EVENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function bindGlobalEvents() {
  // tabs
  document.getElementById('tab-subjects').addEventListener('click', () => switchTab('subjects'));
  document.getElementById('tab-exams').addEventListener('click', () => switchTab('exams'));
  document.getElementById('tab-research').addEventListener('click', () => switchTab('research'));

  // add subject
  document.getElementById('addSubjectBtn').addEventListener('click', () => {
    document.getElementById('addSubjectForm').classList.remove('hidden');
    document.getElementById('mainView').classList.add('hidden');
  });
  document.getElementById('closeSubjectForm').addEventListener('click', closeSubjectForm);
  document.getElementById('uploadImageArea').addEventListener('click', () =>
    document.getElementById('subjectImageInput').click());
  document.getElementById('subjectImageInput').addEventListener('change', async e => {
    const f = e.target.files[0]; if (!f) return;
    const r = new FileReader();
    r.onload = async ev => {
      const c = await compressImage(ev.target.result, 500, .65);
      document.getElementById('subjectImagePreview').innerHTML =
        `<img src="${c}" style="max-width:180px;border-radius:50%;margin-bottom:.5rem">`;
      document.getElementById('subjectImagePreview').dataset.img = c;
    };
    r.readAsDataURL(f);
  });
  document.getElementById('saveSubjectBtn').addEventListener('click', saveSubject);

  // exams
  document.getElementById('addExamBtn').addEventListener('click', () => document.getElementById('addExamForm').classList.remove('hidden'));
  document.getElementById('cancelExamBtn').addEventListener('click', () => document.getElementById('addExamForm').classList.add('hidden'));
  document.getElementById('saveExamBtn').addEventListener('click', addExam);

  // schedule images
  document.getElementById('midExamArea').addEventListener('click', () => document.getElementById('midExamInput').click());
  document.getElementById('finalExamArea').addEventListener('click', () => document.getElementById('finalExamInput').click());
  document.getElementById('midExamInput').addEventListener('change', e => handleScheduleImg(e,'mid'));
  document.getElementById('finalExamInput').addEventListener('change', e => handleScheduleImg(e,'final'));

  // research
  document.getElementById('exportBtn').addEventListener('click', exportData);
  document.getElementById('importBtn').addEventListener('click', () => document.getElementById('importFileInput').click());
  document.getElementById('importFileInput').addEventListener('change', importData);
  document.getElementById('openTextConverter').addEventListener('click', openTextConverter);
  document.getElementById('openOnlineLectures').addEventListener('click', openOnlineLectures);
  document.getElementById('searchInput').addEventListener('input', handleSearch);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUBJECTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function closeSubjectForm() {
  document.getElementById('addSubjectForm').classList.add('hidden');
  document.getElementById('mainView').classList.remove('hidden');
  document.getElementById('subjectName').value = '';
  document.getElementById('doctorName').value = '';
  document.getElementById('subjectImagePreview').innerHTML = '';
  document.getElementById('subjectImagePreview').dataset.img = '';
}

async function saveSubject() {
  const name = document.getElementById('subjectName').value.trim();
  const doc  = document.getElementById('doctorName').value.trim();
  if (!name || !doc) { alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆØ§Ù„Ø¯ÙƒØªÙˆØ±'); return; }
  const img  = document.getElementById('subjectImagePreview').dataset.img || null;
  subjects.push({
    id: Date.now(), name, doctor: doc, image: img,
    weeks: [], practicalExam: null, oralExam: null,
    doctorQuestions: null, doctorQuestionsName: null,
    additionalDoctorFiles: [], myQuestions: '', questionImages: []
  });
  await saveAll();
  renderSubjects(); updateExamDropdown(); closeSubjectForm();
  showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø§Ø¯Ø© âœ“');
}

function renderSubjects() {
  const grid = document.getElementById('subjectsGrid');
  const btn  = document.getElementById('addSubjectBtn');
  grid.innerHTML = '';
  subjects.forEach(s => {
    const c = document.createElement('div');
    c.className = 'subject-card';
    c.innerHTML = `
      <div class="subject-header">
        ${s.image ? `<img src="${s.image}" class="subject-image">` : ''}
        <div class="subject-info" style="flex:1">
          <h3>${s.name}</h3>
          <p>Ø¯. ${s.doctor}</p>
          <p style="color:#3B82F6;font-size:.75rem">${s.weeks.length} Ø£Ø³Ø¨ÙˆØ¹</p>
        </div>
        <button class="delete-btn" data-sid="${s.id}">ğŸ—‘ï¸</button>
      </div>`;
    c.querySelector('[data-sid]').addEventListener('click', e => { e.stopPropagation(); deleteSubject(s.id); });
    c.addEventListener('click', () => showSubjectDetail(s.id));
    grid.appendChild(c);
  });
  grid.appendChild(btn);
}

async function deleteSubject(id) {
  if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø©ØŸ')) return;
  subjects = subjects.filter(s => s.id !== id);
  exams    = exams.filter(e => e.subjectId !== id);
  await saveAll(); renderSubjects(); updateExamDropdown();
  showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù âœ“');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUBJECT DETAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showSubjectDetail(id) {
  currentSubject = subjects.find(s => s.id === id);
  document.getElementById('mainView').classList.add('hidden');
  const view = document.getElementById('subjectView');
  view.classList.remove('hidden');
  view.innerHTML = buildSubjectDetailHTML();
  bindSubjectDetailEvents();
  renderWeeks();
}

function buildSubjectDetailHTML() {
  const s = currentSubject;
  return `
  <button class="back-btn" id="backBtn">â† Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù…ÙˆØ§Ø¯</button>
  <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem">
    ${s.image ? `<img src="${s.image}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:4px solid #BFDBFE">` : ''}
    <div><h2 style="font-size:1.5rem;margin-bottom:.25rem">${s.name}</h2><p style="color:#6B7280">Ø¯. ${s.doctor}</p></div>
  </div>

  <!-- Exam images -->
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem;margin-bottom:1.5rem">
    <div class="upload-area" id="practicalArea">
      <h3 style="font-size:.875rem;margin-bottom:.5rem">Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠ</h3>
      <div id="practicalPreview">${s.practicalExam ? `<div style="position:relative;display:inline-block"><img src="${s.practicalExam}" style="max-width:100%;border-radius:.5rem"><button class="delete-btn" id="delPractical" style="position:absolute;top:4px;left:4px">Ã—</button></div>` : 'ğŸ“¤'}</div>
      <input type="file" id="practicalInput" accept="image/*" class="hidden">
    </div>
    <div class="upload-area" id="oralArea">
      <h3 style="font-size:.875rem;margin-bottom:.5rem">Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø´ÙÙˆÙŠ</h3>
      <div id="oralPreview">${s.oralExam ? `<div style="position:relative;display:inline-block"><img src="${s.oralExam}" style="max-width:100%;border-radius:.5rem"><button class="delete-btn" id="delOral" style="position:absolute;top:4px;left:4px">Ã—</button></div>` : 'ğŸ“¤'}</div>
      <input type="file" id="oralInput" accept="image/*" class="hidden">
    </div>
  </div>

  <!-- Doctor questions -->
  <div style="margin-bottom:1.5rem">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
      <h3>Ù…Ù„Ù Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¯ÙƒØªÙˆØ±</h3>
      ${s.doctorQuestions ? `<button class="btn btn-primary" style="padding:.4rem .8rem;font-size:.75rem" id="addDoctorFileBtn">+ Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ù</button>` : ''}
    </div>
    <div class="upload-area" id="doctorQArea">
      <div id="doctorQPreview">
        ${s.doctorQuestions
          ? `<div class="file-slot has-file" style="border:none;background:transparent"><div style="font-size:1.5rem;color:#10B981">âœ“</div><div class="file-name">${s.doctorQuestionsName}</div><button class="file-open-btn" id="openDoctorQ">ÙØªØ­ Ø§Ù„Ù…Ù„Ù</button></div>`
          : 'ğŸ“¤ Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ù…Ù„Ù PDF'}
      </div>
      <input type="file" id="doctorQInput" accept=".pdf" class="hidden">
    </div>
    ${(s.additionalDoctorFiles||[]).length ? `
    <div style="margin-top:.75rem;display:grid;gap:.5rem">
      ${s.additionalDoctorFiles.map((f,i) => `
      <div style="background:#fff;border:2px solid #E5E7EB;border-radius:.5rem;padding:.6rem;display:flex;align-items:center;gap:.5rem">
        <span style="color:#10B981">ğŸ“„</span>
        <span class="file-name" style="flex:1">${f.name}</span>
        <button class="file-open-btn" data-adf="${i}">ÙØªØ­</button>
        <button class="delete-btn" data-dadf="${i}">Ã—</button>
      </div>`).join('')}
    </div>` : ''}
  </div>

  <!-- My questions -->
  <div style="margin-bottom:1.5rem">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
      <h3>Ø£Ø³Ø¦Ù„ØªÙŠ</h3>
      <button class="btn" style="background:linear-gradient(135deg,#8B5CF6,#EC4899);color:#fff;padding:.5rem 1rem" id="captureQBtn">ğŸ“¸ Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø©</button>
    </div>
    <textarea class="textarea" id="myQTextarea" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªÙŠ Ù„Ù… ØªÙÙ‡Ù…Ù‡Ø§...">${s.myQuestions||''}</textarea>
    <input type="file" id="qImgInput" accept="image/*" capture="environment" class="hidden">
    <div id="qImagesContainer" class="images-scroll" style="margin-top:.75rem">
      ${(s.questionImages||[]).map((img,i) => imgThumbHTML(img, `data-dqi="${i}"`, () => `openBlobImage("${img}")`)).join('')}
    </div>
  </div>

  <!-- Weeks -->
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
    <h3>Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</h3>
    <div style="display:flex;gap:.5rem">
      <button class="btn btn-primary" id="addWeekBtn">â• Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¨ÙˆØ¹</button>
      <button class="btn" style="background:linear-gradient(135deg,#10B981,#059669);color:#fff" id="saveChangesBtn">ğŸ’¾ Ø­ÙØ¸</button>
    </div>
  </div>
  <div id="weeksList"></div>`;
}

function imgThumbHTML(src, delAttr, openFn) {
  return `<div class="img-thumb"><img src="${src}" onclick="${openFn}"><button class="del-img" ${delAttr}>Ã—</button></div>`;
}

function bindSubjectDetailEvents() {
  const s = currentSubject;
  document.getElementById('backBtn').addEventListener('click', backToMain);

  // Practical
  document.getElementById('practicalArea').addEventListener('click', () => document.getElementById('practicalInput').click());
  document.getElementById('practicalInput').addEventListener('change', e => handleExamImg(e,'practicalExam','practicalPreview','delPractical'));
  if (s.practicalExam) document.getElementById('delPractical')?.addEventListener('click', e => { e.stopPropagation(); delExamImg('practicalExam','practicalPreview'); });

  // Oral
  document.getElementById('oralArea').addEventListener('click', () => document.getElementById('oralInput').click());
  document.getElementById('oralInput').addEventListener('change', e => handleExamImg(e,'oralExam','oralPreview','delOral'));
  if (s.oralExam) document.getElementById('delOral')?.addEventListener('click', e => { e.stopPropagation(); delExamImg('oralExam','oralPreview'); });

  // Doctor Q
  document.getElementById('doctorQArea').addEventListener('click', () => document.getElementById('doctorQInput').click());
  document.getElementById('doctorQInput').addEventListener('change', handleDoctorQ);
  document.getElementById('openDoctorQ')?.addEventListener('click', e => { e.stopPropagation(); openBlobURL(s.doctorQuestions, s.doctorQuestionsName); });
  document.getElementById('addDoctorFileBtn')?.addEventListener('click', e => { e.stopPropagation(); document.getElementById('doctorQInput').click(); });

  document.querySelectorAll('[data-adf]').forEach(b => b.addEventListener('click', e => { e.stopPropagation(); const i=+b.dataset.adf; openBlobURL(s.additionalDoctorFiles[i].data, s.additionalDoctorFiles[i].name); }));
  document.querySelectorAll('[data-dadf]').forEach(b => b.addEventListener('click', e => { e.stopPropagation(); deleteDoctorAdditional(+b.dataset.dadf); }));

  // My questions
  document.getElementById('myQTextarea').addEventListener('input', e => { currentSubject.myQuestions = e.target.value; });
  document.getElementById('captureQBtn').addEventListener('click', () => document.getElementById('qImgInput').click());
  document.getElementById('qImgInput').addEventListener('change', handleQImg);

  // Q images delete
  document.getElementById('qImagesContainer').addEventListener('click', e => {
    const b = e.target.closest('[data-dqi]');
    if (b) deleteQImg(+b.dataset.dqi);
  });

  // Weeks
  document.getElementById('addWeekBtn').addEventListener('click', addWeek);
  document.getElementById('saveChangesBtn').addEventListener('click', async () => { await saveAll(); showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ“'); });
}

async function handleExamImg(e, field, previewId, delId) {
  const f = e.target.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = async ev => {
    const c = await compressImage(ev.target.result, 700, .65);
    currentSubject[field] = c;
    const prev = document.getElementById(previewId);
    prev.innerHTML = `<div style="position:relative;display:inline-block"><img src="${c}" style="max-width:100%;border-radius:.5rem"><button class="delete-btn" id="${delId}" style="position:absolute;top:4px;left:4px">Ã—</button></div>`;
    document.getElementById(delId).addEventListener('click', ev2 => { ev2.stopPropagation(); delExamImg(field, previewId); });
    await saveAll(); showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© âœ“');
  };
  r.readAsDataURL(f);
}

async function delExamImg(field, previewId) {
  currentSubject[field] = null;
  document.getElementById(previewId).innerHTML = 'ğŸ“¤';
  await saveAll(); showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù âœ“');
}

async function handleDoctorQ(e) {
  const f = e.target.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = async ev => {
    if (!currentSubject.doctorQuestions) {
      currentSubject.doctorQuestions = ev.target.result;
      currentSubject.doctorQuestionsName = f.name;
    } else {
      if (!currentSubject.additionalDoctorFiles) currentSubject.additionalDoctorFiles = [];
      currentSubject.additionalDoctorFiles.push({name: f.name, data: ev.target.result});
    }
    await saveAll();
    showSubjectDetail(currentSubject.id);
    showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù âœ“');
  };
  r.readAsDataURL(f);
}

async function deleteDoctorAdditional(idx) {
  if (!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ù„ÙØŸ')) return;
  currentSubject.additionalDoctorFiles.splice(idx, 1);
  await saveAll(); showSubjectDetail(currentSubject.id); showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù âœ“');
}

async function handleQImg(e) {
  const f = e.target.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = async ev => {
    const c = await compressImage(ev.target.result, 700, .6);
    if (!currentSubject.questionImages) currentSubject.questionImages = [];
    currentSubject.questionImages.push(c);
    const container = document.getElementById('qImagesContainer');
    const div = document.createElement('div');
    div.className = 'img-thumb';
    div.innerHTML = `<img src="${c}"><button class="del-img" data-dqi="${currentSubject.questionImages.length-1}">Ã—</button>`;
    div.querySelector('img').addEventListener('click', () => openBlobImage(c));
    container.appendChild(div);
    await saveAll(); showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ“');
  };
  r.readAsDataURL(f);
}

async function deleteQImg(idx) {
  currentSubject.questionImages.splice(idx, 1);
  await saveAll();
  document.getElementById('qImagesContainer').innerHTML =
    (currentSubject.questionImages||[]).map((img,i) => `<div class="img-thumb"><img src="${img}" onclick="openBlobImage('${img}')"><button class="del-img" data-dqi="${i}">Ã—</button></div>`).join('');
}

function backToMain() {
  document.getElementById('subjectView').classList.add('hidden');
  document.getElementById('mainView').classList.remove('hidden');
  currentSubject = null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WEEKS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addWeek() {
  currentSubject.weeks.push({
    id: Date.now(), number: currentSubject.weeks.length+1,
    lectureSummary: null, lectureSummaryName: null,
    sectionSummary: null, sectionSummaryName: null,
    questions: null, questionsName: null,
    additionalLectureFiles: [], additionalSectionFiles: [], additionalQuestionsFiles: [],
    lectureImages: [], sectionImages: [], salawatCount: 0
  });
  renderWeeks();
}

function renderWeeks() {
  const list = document.getElementById('weeksList');
  list.innerHTML = '';
  currentSubject.weeks.forEach(w => {
    const card = document.createElement('div');
    card.className = 'week-card';
    card.innerHTML = buildWeekHTML(w);
    list.appendChild(card);
  });
  bindWeekEvents();
}

function buildWeekHTML(w) {
  const fileSlot = (label, data, name, type) => {
    const stored = data ?
      `<div style="font-size:1.2rem;color:#10B981">âœ“</div>
       <div class="file-name">${name}</div>
       <button class="file-open-btn" data-open="${type}" data-wid="${w.id}">ÙØªØ­</button>` :
      `<div style="font-size:1.5rem">ğŸ“¤</div><div style="font-size:.65rem">${label}</div>`;
    const addBtn = data ? `<button class="add-more-btn" data-addfile="${type}" data-wid="${w.id}" style="background:linear-gradient(135deg,#8B5CF6,#EC4899)">+</button>` : '';
    return `<div class="file-slot${data?' has-file':''}" data-slot="${type}" data-wid="${w.id}">${addBtn}${stored}</div>`;
  };

  const additionalFiles = (arr, type, wid) => arr && arr.length ? arr.map((f,i) => `
    <div style="background:#fff;border:1px solid #E5E7EB;border-radius:.4rem;padding:.4rem .6rem;display:flex;align-items:center;gap:.4rem;font-size:.7rem">
      <span style="color:#8B5CF6">ğŸ“„</span>
      <span class="file-name" style="flex:1">${f.name}</span>
      <button class="file-open-btn" data-openaf="${i}" data-aft="${type}" data-afwid="${wid}" style="padding:.15rem .4rem">ÙØªØ­</button>
      <button class="delete-btn" style="width:20px;height:20px;font-size:.7rem" data-delaf="${i}" data-daft="${type}" data-dafwid="${wid}">Ã—</button>
    </div>`).join('') : '';

  const imgSection = (label, imgs, type, wid, color) => `
    <div style="margin-top:.75rem;padding-top:.75rem;border-top:2px solid #D1FAE5">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
        <h5 style="margin:0;font-size:.8rem;color:#1F2937">ğŸ“¸ ØµÙˆØ± ${label}</h5>
        <button class="btn" style="background:linear-gradient(135deg,${color});color:#fff;padding:.3rem .6rem;font-size:.7rem;border-radius:.4rem" data-addimg="${type}" data-wid="${wid}">+ ØµÙˆØ±Ø©</button>
      </div>
      <div class="images-scroll" id="imgs_${type}_${wid}">
        ${(imgs||[]).map((src,i) => `
          <div class="img-thumb" data-wid="${wid}" data-type="${type}" data-idx="${i}">
            <img src="${src}" onclick="openBlobImage('${src}')">
            <button class="del-img" data-delwi="${i}" data-dwtype="${type}" data-dwwid="${wid}">Ã—</button>
          </div>`).join('')}
        <input type="file" id="imgInput_${type}_${wid}" accept="image/*" multiple class="hidden">
      </div>
    </div>`;

  return `
  <div class="week-header">
    <h4>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${w.number}</h4>
    <span class="salawat-btn" data-swid="${w.id}">ØµÙ„ÙÙ‘ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¨ÙŠ ï·º${w.salawatCount ? ` (${w.salawatCount})` : ''}</span>
  </div>
  <div class="week-files">
    ${fileSlot('Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©', w.lectureSummary, w.lectureSummaryName, 'lecture')}
    ${fileSlot('Ù…Ù„Ø®Øµ Ø§Ù„Ø³ÙƒØ´Ù†', w.sectionSummary, w.sectionSummaryName, 'section')}
    ${fileSlot('Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©', w.questions, w.questionsName, 'questions')}
  </div>
  ${(w.additionalLectureFiles||[]).length ? `<div style="margin-top:.5rem">${additionalFiles(w.additionalLectureFiles,'lecture',w.id)}</div>` : ''}
  ${(w.additionalSectionFiles||[]).length ? `<div style="margin-top:.5rem">${additionalFiles(w.additionalSectionFiles,'section',w.id)}</div>` : ''}
  ${(w.additionalQuestionsFiles||[]).length ? `<div style="margin-top:.5rem">${additionalFiles(w.additionalQuestionsFiles,'questions',w.id)}</div>` : ''}
  ${imgSection('Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©', w.lectureImages, 'lecture', w.id, '#8B5CF6,#EC4899')}
  ${imgSection('Ø§Ù„Ø³ÙƒØ´Ù†',   w.sectionImages, 'section', w.id, '#F59E0B,#D97706')}`;
}

function bindWeekEvents() {
  // File slots (click to upload)
  document.querySelectorAll('.file-slot').forEach(slot => {
    slot.addEventListener('click', e => {
      if (e.target.closest('button')) return;
      const wid = +slot.dataset.wid, type = slot.dataset.slot;
      pickWeekFile(wid, type);
    });
  });

  // Open main file
  document.querySelectorAll('[data-open]').forEach(b => b.addEventListener('click', e => {
    e.stopPropagation();
    const w = currentSubject.weeks.find(x => x.id === +b.dataset.wid);
    const map = {lecture:['lectureSummary','lectureSummaryName'], section:['sectionSummary','sectionSummaryName'], questions:['questions','questionsName']};
    const [df, nf] = map[b.dataset.open];
    openBlobURL(w[df], w[nf]);
  }));

  // Add more file button
  document.querySelectorAll('[data-addfile]').forEach(b => b.addEventListener('click', e => {
    e.stopPropagation();
    addAdditionalWeekFile(+b.dataset.wid, b.dataset.addfile);
  }));

  // Open additional file
  document.querySelectorAll('[data-openaf]').forEach(b => b.addEventListener('click', e => {
    e.stopPropagation();
    const w = currentSubject.weeks.find(x => x.id === +b.dataset.afwid);
    const arr = getAFArr(w, b.dataset.aft);
    openBlobURL(arr[+b.dataset.openaf].data, arr[+b.dataset.openaf].name);
  }));

  // Delete additional file
  document.querySelectorAll('[data-delaf]').forEach(b => b.addEventListener('click', e => {
    e.stopPropagation();
    delAdditionalWeekFile(+b.dataset.dafwid, b.dataset.daft, +b.dataset.delaf);
  }));

  // Add image
  document.querySelectorAll('[data-addimg]').forEach(b => b.addEventListener('click', e => {
    e.stopPropagation();
    document.getElementById(`imgInput_${b.dataset.addimg}_${b.dataset.wid}`).click();
  }));

  // Image inputs
  currentSubject.weeks.forEach(w => {
    ['lecture','section'].forEach(type => {
      const inp = document.getElementById(`imgInput_${type}_${w.id}`);
      if (inp) inp.addEventListener('change', e => handleWeekImages(e, w.id, type));
    });
  });

  // Delete week image
  document.querySelectorAll('[data-delwi]').forEach(b => b.addEventListener('click', e => {
    e.stopPropagation();
    delWeekImage(+b.dataset.dwwid, b.dataset.dwtype, +b.dataset.delwi);
  }));

  // Salawat
  document.querySelectorAll('[data-swid]').forEach(b => b.addEventListener('click', async () => {
    const w = currentSubject.weeks.find(x => x.id === +b.dataset.swid);
    w.salawatCount = (w.salawatCount||0)+1;
    b.textContent = `ØµÙ„ÙÙ‘ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¨ÙŠ ï·º (${w.salawatCount})`;
    b.style.transform = 'scale(1.2)';
    setTimeout(() => b.style.transform = '', 200);
    await saveAll();
  }));
}

function getAFArr(w, type) {
  if (type==='lecture') return w.additionalLectureFiles||[];
  if (type==='section') return w.additionalSectionFiles||[];
  return w.additionalQuestionsFiles||[];
}

function setAFArr(w, type, arr) {
  if (type==='lecture') w.additionalLectureFiles = arr;
  else if (type==='section') w.additionalSectionFiles = arr;
  else w.additionalQuestionsFiles = arr;
}

function pickWeekFile(wid, type) {
  const inp = document.createElement('input');
  inp.type = 'file'; inp.accept = '.pdf';
  inp.onchange = async e => {
    const f = e.target.files[0]; if (!f) return;
    const r = new FileReader();
    r.onload = async ev => {
      const w = currentSubject.weeks.find(x => x.id === wid);
      if (type==='lecture') { w.lectureSummary = ev.target.result; w.lectureSummaryName = f.name; }
      else if (type==='section') { w.sectionSummary = ev.target.result; w.sectionSummaryName = f.name; }
      else { w.questions = ev.target.result; w.questionsName = f.name; }
      await saveAll(); renderWeeks(); showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù âœ“');
    };
    r.readAsDataURL(f);
  };
  inp.click();
}

function addAdditionalWeekFile(wid, type) {
  const inp = document.createElement('input');
  inp.type = 'file'; inp.accept = '.pdf';
  inp.onchange = async e => {
    const f = e.target.files[0]; if (!f) return;
    const r = new FileReader();
    r.onload = async ev => {
      const w = currentSubject.weeks.find(x => x.id === wid);
      const arr = [...getAFArr(w,type), {name:f.name, data:ev.target.result}];
      setAFArr(w, type, arr);
      await saveAll(); renderWeeks(); showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ“');
    };
    r.readAsDataURL(f);
  };
  inp.click();
}

async function delAdditionalWeekFile(wid, type, idx) {
  if (!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ù„ÙØŸ')) return;
  const w = currentSubject.weeks.find(x => x.id === wid);
  const arr = getAFArr(w, type);
  arr.splice(idx,1); setAFArr(w, type, arr);
  await saveAll(); renderWeeks(); showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù âœ“');
}

async function handleWeekImages(e, wid, type) {
  const files = Array.from(e.target.files); if (!files.length) return;
  const w = currentSubject.weeks.find(x => x.id === wid);
  const arr = type==='lecture' ? (w.lectureImages||[]) : (w.sectionImages||[]);
  showToast('Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±...');
  for (const f of files) {
    await new Promise(res => {
      const r = new FileReader();
      r.onload = async ev => {
        const c = await compressImage(ev.target.result, 700, .6);
        arr.push(c);
        // Append thumbnail immediately
        const container = document.getElementById(`imgs_${type}_${wid}`);
        if (container) {
          const div = document.createElement('div');
          div.className = 'img-thumb';
          const idx = arr.length-1;
          div.innerHTML = `<img src="${c}"><button class="del-img" data-delwi="${idx}" data-dwtype="${type}" data-dwwid="${wid}">Ã—</button>`;
          div.querySelector('img').addEventListener('click', () => openBlobImage(c));
          div.querySelector('.del-img').addEventListener('click', e2 => { e2.stopPropagation(); delWeekImage(wid,type,idx); });
          // Insert before the hidden input
          const inp = container.querySelector(`#imgInput_${type}_${wid}`);
          container.insertBefore(div, inp);
        }
        res();
      };
      r.readAsDataURL(f);
    });
  }
  if (type==='lecture') w.lectureImages = arr; else w.sectionImages = arr;
  await saveAll(); showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ“');
}

async function delWeekImage(wid, type, idx) {
  const w = currentSubject.weeks.find(x => x.id === wid);
  if (type==='lecture') w.lectureImages.splice(idx,1); else w.sectionImages.splice(idx,1);
  await saveAll(); renderWeeks(); showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù âœ“');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXAMS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateExamDropdown() {
  const sel = document.getElementById('examSubject');
  sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>';
  subjects.forEach(s => {
    const o = document.createElement('option');
    o.value = s.id; o.textContent = s.name;
    sel.appendChild(o);
  });
}

async function addExam() {
  const sid  = +document.getElementById('examSubject').value;
  const type = document.getElementById('examType').value;
  const date = document.getElementById('examDate').value;
  const time = document.getElementById('examTime').value;
  if (!sid||!date||!time) { alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); return; }
  const s = subjects.find(x => x.id === sid);
  exams.push({id:Date.now(), subjectId:sid, subjectName:s.name, type, date, time, examImage:null, examImageName:null});
  await saveAll(); renderExamSchedule();
  document.getElementById('addExamForm').classList.add('hidden');
  showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† âœ“');
}

function renderExamSchedule() {
  const tbody = document.getElementById('examTableBody');
  if (!exams.length) { tbody.innerHTML='<tr><td colspan="6" style="text-align:center;color:#6B7280">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</td></tr>'; return; }
  tbody.innerHTML = '';
  [...exams].sort((a,b) => new Date(a.date+' '+a.time)-new Date(b.date+' '+b.time)).forEach(ex => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${ex.subjectName}</td>
      <td><span class="badge badge-${ex.type}">${ex.type==='mid'?'Ù…ÙŠØ¯ ØªÙŠØ±Ù…':'ÙØ§ÙŠÙ†Ø§Ù„'}</span></td>
      <td>${ex.date}</td><td>${ex.time}</td>
      <td>${ex.examImage
        ? `<button class="btn" style="background:#3B82F6;color:#fff;padding:.4rem .8rem;font-size:.8rem" data-viewex="${ex.id}">ğŸ‘ï¸ Ø¹Ø±Ø¶</button>`
        : `<button class="btn" style="background:#10B981;color:#fff;padding:.4rem .8rem;font-size:.8rem" data-uploadex="${ex.id}">ğŸ“¤ Ø±ÙØ¹</button>`}</td>
      <td><button class="btn-danger btn" style="padding:.4rem .8rem;font-size:.8rem" data-delex="${ex.id}">Ø­Ø°Ù</button></td>`;
    tbody.appendChild(tr);
  });

  document.querySelectorAll('[data-delex]').forEach(b => b.addEventListener('click', async () => {
    if (!confirm('Ø­Ø°Ù Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†ØŸ')) return;
    exams = exams.filter(e => e.id !== +b.dataset.delex);
    await saveAll(); renderExamSchedule(); showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù âœ“');
  }));
  document.querySelectorAll('[data-uploadex]').forEach(b => b.addEventListener('click', () => uploadExamImg(+b.dataset.uploadex)));
  document.querySelectorAll('[data-viewex]').forEach(b => b.addEventListener('click', () => {
    const ex = exams.find(e => e.id === +b.dataset.viewex);
    if (ex?.examImage) openBlobImage(ex.examImage);
  }));
}

function uploadExamImg(eid) {
  const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*';
  inp.onchange = async e => {
    const f = e.target.files[0]; if (!f) return;
    const r = new FileReader();
    r.onload = async ev => {
      const c = await compressImage(ev.target.result, 700, .65);
      const ex = exams.find(x => x.id === eid);
      ex.examImage = c; ex.examImageName = f.name;
      await saveAll(); renderExamSchedule(); showToast('ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© âœ“');
    };
    r.readAsDataURL(f);
  };
  inp.click();
}

async function handleScheduleImg(e, type) {
  const f = e.target.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = async ev => {
    const c = await compressImage(ev.target.result, 900, .7);
    scheduleImages[type] = c;
    await saveAll(); renderScheduleImages(); showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„ âœ“');
  };
  r.readAsDataURL(f);
}

function renderScheduleImages() {
  ['mid','final'].forEach(type => {
    const prev = document.getElementById(`${type}ExamPreview`);
    if (scheduleImages[type]) {
      prev.innerHTML = `<div style="position:relative;display:inline-block;width:100%">
        <img src="${scheduleImages[type]}" style="max-width:100%;border-radius:.5rem;cursor:pointer" onclick="openBlobImage('${scheduleImages[type]}')">
        <button class="delete-btn" style="position:absolute;top:4px;left:4px" onclick="delScheduleImg('${type}')">Ã—</button>
      </div>`;
    } else {
      prev.innerHTML = `ğŸ“¤ Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¬Ø¯ÙˆÙ„ ${type==='mid'?'Ø§Ù„Ù…ÙŠØ¯ ØªÙŠØ±Ù…':'Ø§Ù„ÙØ§ÙŠÙ†Ø§Ù„'}`;
    }
  });
}

async function delScheduleImg(type) {
  if (!confirm('Ø­Ø°Ù ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ØŸ')) return;
  scheduleImages[type] = null;
  await saveAll(); renderScheduleImages(); showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù âœ“');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT / IMPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function exportData() {
  const btn = document.getElementById('exportBtn');
  btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±...'; btn.disabled = true;
  const payload = JSON.stringify({version:'2.0',date:new Date().toISOString(),subjects,exams,scheduleImages,onlineLectures}, null, 2);
  const blob = new Blob([payload], {type:'application/json'});
  const url  = URL.createObjectURL(blob);
  const a    = Object.assign(document.createElement('a'), {href:url, download:`be-regular-backup-${new Date().toISOString().slice(0,10)}.json`});
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
  btn.textContent = 'ğŸ“¦ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'; btn.disabled = false;
  showToast('ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ± âœ“');
}

async function importData(e) {
  const f = e.target.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = async ev => {
    try {
      const data = JSON.parse(ev.target.result);
      if (!data.subjects) throw new Error('invalid');
      if (!confirm(`Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ\nğŸ“š ${data.subjects.length} Ù…Ø§Ø¯Ø©\nğŸ“ ${data.exams?.length||0} Ø§Ù…ØªØ­Ø§Ù†`)) return;
      subjects        = data.subjects || [];
      exams           = data.exams || [];
      scheduleImages  = data.scheduleImages || {mid:null,final:null};
      onlineLectures  = data.onlineLectures || [];
      await saveAll(); renderSubjects(); updateExamDropdown();
      showToast('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ“');
    } catch(_) { alert('Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­'); }
    document.getElementById('importFileInput').value = '';
  };
  r.readAsText(f);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleSearch(e) {
  const q = e.target.value.toLowerCase().trim();
  const cont = document.getElementById('searchResultsContent');
  const stat = document.getElementById('staticResources');
  if (!q) { cont.innerHTML=''; stat.classList.remove('hidden'); return; }
  stat.classList.add('hidden');

  const results = [];
  subjects.forEach(s => {
    if (s.name.toLowerCase().includes(q) || s.doctor.toLowerCase().includes(q)) {
      results.push({icon:'ğŸ“š', title:s.name, desc:`Ø¯. ${s.doctor}`, action:() => { switchTab('subjects'); setTimeout(()=>showSubjectDetail(s.id),100); }});
    }
    s.weeks.forEach(w => {
      [[w.lectureSummaryName,'lecture'],[w.sectionSummaryName,'section'],[w.questionsName,'questions']].forEach(([n,t]) => {
        if (n?.toLowerCase().includes(q)) results.push({icon:'ğŸ“„', title:n, desc:`${s.name} - Ø£Ø³Ø¨ÙˆØ¹ ${w.number}`, action:()=>{ switchTab('subjects'); setTimeout(()=>showSubjectDetail(s.id),100); }});
      });
    });
  });
  exams.forEach(ex => {
    if (ex.subjectName.toLowerCase().includes(q)) results.push({icon:'ğŸ“', title:`Ø§Ù…ØªØ­Ø§Ù† ${ex.type==='mid'?'Ù…ÙŠØ¯ ØªÙŠØ±Ù…':'ÙØ§ÙŠÙ†Ø§Ù„'}`, desc:`${ex.subjectName} - ${ex.date}`, action:()=>switchTab('exams')});
  });

  if (!results.length) { cont.innerHTML='<div style="text-align:center;padding:2rem;color:#6B7280">ğŸ” Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>'; return; }
  cont.innerHTML = `<h3 style="margin-bottom:1rem;color:#1F2937">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« (${results.length})</h3>`;
  results.forEach(r => {
    const d = document.createElement('div'); d.className='res-card'; d.style.cursor='pointer';
    d.innerHTML = `<div style="display:flex;align-items:center;gap:1rem"><div style="font-size:2rem">${r.icon}</div><div style="flex:1"><h4 style="margin:0">${r.title}</h4><p style="margin:0;color:#6B7280;font-size:.875rem">${r.desc}</p></div><div style="color:#3B82F6;font-size:1.5rem">â†’</div></div>`;
    d.addEventListener('click', r.action);
    cont.appendChild(d);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TEXT CONVERTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openTextConverter() {
  const m = document.createElement('div');
  m.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:99997;overflow-y:auto;padding:1rem';
  m.innerHTML = `
  <div style="background:#fff;border-radius:1rem;padding:2rem;max-width:1100px;margin:auto">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
      <h2>âœï¸ Ù…Ø­ÙˆÙ„ Ø§Ù„Ù†ØµÙˆØµ</h2>
      <button onclick="this.closest('div[style*=fixed]').remove()" class="btn btn-danger">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <textarea id="tcInput" class="textarea" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„Ù†Øµ Ù‡Ù†Ø§..." style="min-height:120px"></textarea>
    <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin:1rem 0">
      <button onclick="document.execCommand('bold')" class="btn" style="background:#3B82F6;color:#fff;font-weight:700">B</button>
      <button onclick="document.execCommand('italic')" class="btn" style="background:#3B82F6;color:#fff;font-style:italic">I</button>
      <button onclick="document.execCommand('underline')" class="btn" style="background:#3B82F6;color:#fff;text-decoration:underline">U</button>
      <button onclick="hlText('yellow')" class="btn" style="background:#FEF08A">ğŸŸ¨</button>
      <button onclick="hlText('green')" class="btn" style="background:#BBF7D0">ğŸŸ©</button>
      <button onclick="hlText('blue')" class="btn" style="background:#BFDBFE">ğŸŸ¦</button>
      <button onclick="hlText('pink')" class="btn" style="background:#FBCFE8">ğŸŸª</button>
      <button onclick="tcFontSize(2)" class="btn" style="background:#6B7280;color:#fff">A+</button>
      <button onclick="tcFontSize(-2)" class="btn" style="background:#6B7280;color:#fff">A-</button>
    </div>
    <div id="tcEditor" contenteditable="true" style="min-height:300px;max-height:60vh;overflow-y:auto;padding:1.5rem;border:2px solid #D1D5DB;border-radius:.75rem;font-size:16px;line-height:1.8;column-count:2;column-gap:2rem"></div>
    <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:1rem">
      <button onclick="tcConvert()" class="btn btn-primary">âœ“ ØªØ­ÙˆÙŠÙ„</button>
      <button onclick="tcClear()" class="btn" style="background:#F59E0B;color:#fff">ğŸ—‘ï¸ Ù…Ø³Ø­</button>
      <button onclick="tcCopy()" class="btn" style="background:#8B5CF6;color:#fff">ğŸ“‹ Ù†Ø³Ø®</button>
      <button onclick="tcPrint()" class="btn" style="background:#EC4899;color:#fff">ğŸ“¥ Ø·Ø¨Ø§Ø¹Ø© / PDF</button>
    </div>
  </div>`;
  document.body.appendChild(m);
  m.querySelector('#tcInput').addEventListener('input', tcConvert);
}

function hlText(color) {
  const s = window.getSelection(); if (!s.rangeCount) return;
  const r = s.getRangeAt(0), sp = document.createElement('span');
  sp.style.backgroundColor = {yellow:'#FEF08A',green:'#BBF7D0',blue:'#BFDBFE',pink:'#FBCFE8'}[color];
  sp.style.borderRadius = '3px'; sp.style.padding = '1px 3px';
  try { r.surroundContents(sp); } catch(_) { const c=r.extractContents(); sp.appendChild(c); r.insertNode(sp); }
  document.getElementById('tcEditor').focus();
}

function tcFontSize(delta) {
  const ed = document.getElementById('tcEditor');
  ed.style.fontSize = (parseInt(getComputedStyle(ed).fontSize)||16)+delta+'px';
}

function tcConvert() {
  const ed = document.getElementById('tcEditor');
  if (!ed.innerHTML) ed.innerHTML = document.getElementById('tcInput').value.replace(/\n/g,'<br>');
}

function tcClear() {
  if (confirm('Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ØŸ')) { document.getElementById('tcInput').value=''; document.getElementById('tcEditor').innerHTML=''; }
}

function tcCopy() {
  const ed = document.getElementById('tcEditor');
  const r = document.createRange(); r.selectNodeContents(ed);
  const s = window.getSelection(); s.removeAllRanges(); s.addRange(r);
  document.execCommand('copy'); s.removeAllRanges();
  showToast('ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ“');
}

function tcPrint() {
  const ed = document.getElementById('tcEditor');
  const w = window.open('','','width=900,height=700');
  w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><style>body{font-family:'Segoe UI',sans-serif;padding:2cm;font-size:14pt;line-height:1.8}
  span[style*="background"]{border-radius:3px;padding:1px 3px}</style></head><body>${ed.innerHTML}</body></html>`);
  w.document.close(); w.focus(); setTimeout(() => { w.print(); w.close(); }, 400);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ONLINE LECTURES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openOnlineLectures() {
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }
  const m = document.createElement('div');
  m.id = '_olModal';
  m.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:99997;overflow-y:auto;padding:1rem';
  m.innerHTML = `
  <div style="background:#fff;border-radius:1rem;padding:2rem;max-width:900px;margin:auto">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
      <h2>ğŸ• Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</h2>
      <button onclick="document.getElementById('_olModal').remove()" class="btn btn-danger">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div style="background:linear-gradient(135deg,#F0F9FF,#E0E7FF);border-radius:.75rem;padding:1.5rem;margin-bottom:1.5rem">
      <h3 style="margin-bottom:1rem">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø§Ø¶Ø±Ø©</h3>
      <div style="display:grid;gap:.75rem">
        <select id="olSubject" class="input"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>${subjects.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}</select>
        <input type="text" id="olTitle" class="input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
        <input type="date" id="olDate" class="input">
        <input type="time" id="olTime" class="input">
        <input type="url" id="olLink" class="input" placeholder="Ø±Ø§Ø¨Ø· Zoom/Teams">
        <div style="display:flex;gap:1rem;align-items:center;flex-wrap:wrap">
          <label style="font-size:.875rem;color:#6B7280">Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª: <input type="number" id="olCount" class="input" min="1" max="10" value="3" style="width:70px;display:inline;padding:.4rem"></label>
          <label style="font-size:.875rem;color:#6B7280">ÙƒÙ„: <input type="number" id="olInterval" class="input" min="5" max="120" value="15" style="width:70px;display:inline;padding:.4rem"> Ø¯Ù‚ÙŠÙ‚Ø©</label>
        </div>
        <button onclick="addOL()" class="btn btn-primary">Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</button>
      </div>
    </div>
    <div id="olList">${renderOLList()}</div>
  </div>`;
  document.body.appendChild(m);
}

function renderOLList() {
  if (!onlineLectures.length) return '<p style="text-align:center;color:#6B7280;padding:1.5rem">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª</p>';
  return [...onlineLectures]
    .sort((a,b)=>new Date(a.date+' '+a.time)-new Date(b.date+' '+b.time))
    .map(l => {
      const s = subjects.find(x=>x.id===l.subjectId);
      const past = new Date(l.date+' '+l.time) < new Date();
      return `<div style="background:${past?'#F3F4F6':'#fff'};border:2px solid ${past?'#E5E7EB':'#BFDBFE'};border-radius:.75rem;padding:1.25rem;margin-bottom:.75rem;${past?'opacity:.7':''}">
        <div style="display:flex;justify-content:space-between;align-items:start">
          <div><h4 style="margin:0 0 .25rem">${l.title||'Ù…Ø­Ø§Ø¶Ø±Ø©'}</h4>
          <p style="margin:0;font-size:.875rem;color:#6B7280">ğŸ“š ${s?s.name:'Ù…Ø§Ø¯Ø© Ù…Ø­Ø°ÙˆÙØ©'} â€” ğŸ“… ${l.date} â° ${l.time}</p>
          ${l.link?`<a href="${l.link}" target="_blank" style="color:#3B82F6;font-size:.875rem">ğŸ”— ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·</a>`:''}
          <p style="margin:.25rem 0 0;font-size:.75rem;color:#8B5CF6">ğŸ”” ${l.notificationCount} Ø¥Ø´Ø¹Ø§Ø± ÙƒÙ„ ${l.notificationInterval} Ø¯Ù‚ÙŠÙ‚Ø©</p></div>
          <button class="delete-btn" onclick="delOL(${l.id})">ğŸ—‘ï¸</button>
        </div>
      </div>`;
    }).join('');
}

async function addOL() {
  const sid = +document.getElementById('olSubject').value;
  const date = document.getElementById('olDate').value;
  const time = document.getElementById('olTime').value;
  if (!sid||!date||!time) { alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª'); return; }
  onlineLectures.push({
    id:Date.now(), subjectId:sid,
    title:document.getElementById('olTitle').value,
    date, time,
    link:document.getElementById('olLink').value,
    notificationCount:+document.getElementById('olCount').value,
    notificationInterval:+document.getElementById('olInterval').value,
    notificationsSent:[]
  });
  await saveAll();
  const list = document.getElementById('olList');
  if (list) list.innerHTML = renderOLList();
  showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© âœ“');
}

async function delOL(id) {
  if (!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©ØŸ')) return;
  onlineLectures = onlineLectures.filter(l=>l.id!==id);
  await saveAll();
  const list = document.getElementById('olList');
  if (list) list.innerHTML = renderOLList();
  showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù âœ“');
}

function checkUpcomingLectures() {
  if (!('Notification' in window) || Notification.permission !== 'granted') return;
  const now = new Date();
  onlineLectures.forEach(l => {
    if (!l.notificationsSent) l.notificationsSent = [];
    const ldt = new Date(l.date+' '+l.time);
    for (let i=0; i<l.notificationCount; i++) {
      const nt = new Date(ldt.getTime() - i*l.notificationInterval*60000);
      const diff = nt - now;
      const key = `${l.id}_${i}`;
      if (diff > 0 && diff <= 60000 && !l.notificationsSent.includes(key)) {
        const s = subjects.find(x=>x.id===l.subjectId);
        new Notification('Be Regular â€” ØªØ°ÙƒÙŠØ± Ù…Ø­Ø§Ø¶Ø±Ø©', {
          body:`${l.title||'Ù…Ø­Ø§Ø¶Ø±Ø©'} (${s?s.name:''})\nØªØ¨Ø¯Ø£ Ø¨Ø¹Ø¯ ${i*l.notificationInterval} Ø¯Ù‚ÙŠÙ‚Ø© Ø§Ù„Ø³Ø§Ø¹Ø© ${l.time}`,
          tag: key
        });
        l.notificationsSent.push(key);
        saveAll();
      }
    }
  });
}
</script>
</body>
</html>
